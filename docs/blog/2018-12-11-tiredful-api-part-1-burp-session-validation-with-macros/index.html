<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>Tiredful API - Part 1 - Burp Session Validation with Macros</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="http://localhost:1313/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="[Parsia Hakimian Parsiya infosec information security]">
  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.83.1" />

  
  

  
  
    

  
  
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image:src" content="http://localhost:1313/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/06-session-rule-2.png"/>
  
  
  <meta name="twitter:title" content="Tiredful API - Part 1 - Burp Session Validation with Macros"/>
  <meta name="twitter:description" content="Tiredful API is an intentionally vulnerable REST API. I am going to use it to practice a bunch of Burp tricks.

In this part, I want to show how to use Burp macros to detect invalid session and add a custom bearer token header to the requests."/>
  
  <meta name="twitter:domain" content="parsiya.net"/>
  <meta name="twitter:creator" content="@CryptoGangsta"/>

  

  
  



</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="http://localhost:1313/">அஃக</a></h1>
    <h2>தமிழின் பெரிய சொற்தொகுப்பு</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="http://localhost:1313/about/">» About Me!</option>
      
        <option value="http://localhost:1313/letters/">» எழுத்து</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="http://localhost:1313/about/" title="About Me!"  target="_blank"  rel="noopener noreferrer">About Me!</a></li>
    
  
    
      <li><a href="http://localhost:1313/letters/" title="எழுத்து"  target="_blank"  rel="noopener noreferrer">எழுத்து</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="http://localhost:1313/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:http://localhost:1313/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Dec 11, 2018
     - 5 minute read 
     - <a href="http://localhost:1313/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="http://localhost:1313/categories/burp/">Burp </a><a class="label" href="http://localhost:1313/categories/writeup/">Writeup </a>
    
  </p>
  <h1 class="entry-title">
     Tiredful API - Part 1 - Burp Session Validation with Macros 
  </h1>
</header>


        <div class="entry-content">
          
          
          
            <nav id="TableOfContents">
<ul>
<li><a href="#session-validation-using-macros">Session Validation Using Macros</a></li>
<li><a href="#login-request">Login Request</a></li>
<li><a href="#invalid-session-response">Invalid Session Response</a></li>
<li><a href="#login-macro">Login Macro</a></li>
<li><a href="#session-validation">Session Validation</a>
<ul>
<li><a href="#add-custom-header-extension">Add Custom Header Extension</a></li>
<li><a href="#session-handling-rule">Session Handling Rule</a></li>
<li><a href="#alternate-session-handling-rule">Alternate Session Handling Rule</a></li>
<li><a href="#setting-the-scope">Setting the Scope</a></li>
</ul></li>
<li><a href="#burp-in-action">Burp in Action</a></li>
</ul>
</nav>
          
          <p><a href="https://github.com/payatu/Tiredful-API" rel="nofollow" target="_blank">Tiredful API</a> is an intentionally vulnerable REST API. I am going to use it to practice a bunch of Burp tricks.</p>

<p>In this part, I want to show how to use Burp macros to detect invalid session and add a custom bearer token header to the requests.</p>

<p>I used the instructions to spin up a <a href="https://github.com/payatu/Tiredful-API#docker-container" rel="nofollow" target="_blank">docker container</a> and used it with the free Burp Community Edition 1.7.36.</p>

<h1 id="session-validation-using-macros">Session Validation Using Macros</h1>

<p>Often times the session times out in the middle of testing or scanning. I only use Burp's scanner on individual requests but session can still time out. Sometimes the application log users out after sending funny payloads. Burp allows you to detect invalidated sessions and run a macro (which is a series of requests) to update the session automagically.</p>

<p>Usually, the session is maintained by cookies and Burp's cookie jar can be automatically updated to refresh the session. In the case of this API, we are using a Bearer token. But this method can be used for any custom header containing a token.</p>

<h1 id="login-request">Login Request</h1>

<p>The login request is simple. While this example has only one request, the process for multiple-step requests is similar. The application has two registered users. We are using <code>batman:Batman@123</code>.</p>






<span class="caption-wrapper">
  <img class="caption" src="01-login.png" title="Successful login request" alt="Successful login request">
  <span class="caption-text">Successful login request</span>
</span>


<p>The <code>access_token</code> must be added to every authenticated request like <code>Authorization : Bearer [token]</code>.</p>

<h1 id="invalid-session-response">Invalid Session Response</h1>

<p>We also need to detect invalidate sessions. To do so, navigate to <a href="http://192.168.99.100:8000/api/v1/advertisements/" rel="nofollow" target="_blank">http://192.168.99.100:8000/api/v1/advertisements/</a> to see the response.</p>






<span class="caption-wrapper">
  <img class="caption" src="04-invalid-session.png" title="Invalid request" alt="Invalid request">
  <span class="caption-text">Invalid request</span>
</span>


<p>We are going to use the header <code>401 Unauthorized</code> to detect invalid requests.</p>

<h1 id="login-macro">Login Macro</h1>

<p>We should create a login macro to login as <code>batman</code>. This macro will be executed when Burp detects an invalid/expired session.</p>

<ol>
<li>Go to <code>Project Options &gt; Sessions</code> and scroll down to <code>Macros</code>.</li>
<li>Select <code>Add</code> to create a new macro. Macros are created from existing requests.</li>
<li>Select a successful login request (for multi-step logins, select all steps in the login flow) and press <code>Ok</code>.





<span class="caption-wrapper">
  <img class="caption" src="02-macro1.png" title="Selecting the login request in macro recorder" alt="Selecting the login request in macro recorder">
  <span class="caption-text">Selecting the login request in macro recorder</span>
</span>
</li>
<li>Select a name and press <code>Ok</code> in <code>Macro Editor</code> to create the macro. If the request had specific parameters (e.g. a CSRF token), we could designate it in <code>Configure item</code>. This example does not need it.





<span class="caption-wrapper">
  <img class="caption" src="03-macro2.png" title="Finish macro recording" alt="Finish macro recording">
  <span class="caption-text">Finish macro recording</span>
</span>
</li>
</ol>

<h1 id="session-validation">Session Validation</h1>

<p>We need to make Burp perform two action:</p>

<ol>
<li>Create a session handling rule. Burp should run the macro whenever a session is invalid.</li>
<li>Add the <code>access_token</code> as a custom header to that request and resend it.</li>
</ol>

<h2 id="add-custom-header-extension">Add Custom Header Extension</h2>

<p>In order to accomplish number two, we need to use an extension. Burp vanilla does not support adding headers to requests in session validation rules. However, cookies and normal GET/POST parameters (e.g. <code>form-urlencoded</code> ) can be updated.</p>

<ol>
<li>Install the <code>Add Custom Header</code> extension at <a href="https://github.com/lorenzog/burpAddCustomHeader" rel="nofollow" target="_blank">https://github.com/lorenzog/burpAddCustomHeader</a>. It's also available in the Burp App Store.</li>
<li>Navigate to the <code>Add Custom Header</code> tab. It's pre-populated with some sane defaults.</li>
<li>The original regex is <code>access_token&quot;:&quot;(.*?)&quot;</code>. The underline does not show up in the input field but you can click on <code>Update Preview</code> to see it.</li>
<li>We need to change the regex. Our response is a bit different. Ours has an extra space after <code>access_token&quot;:</code>. Our regex will be <code>access_token&quot;: &quot;(.*?)&quot;</code> instead.





<span class="caption-wrapper">
  <img class="caption" src="08-add-custom-header.png" title="Add Custom Header setup" alt="Add Custom Header setup">
  <span class="caption-text">Add Custom Header setup</span>
</span>
</li>
</ol>

<h2 id="session-handling-rule">Session Handling Rule</h2>

<ol>
<li>In the same screen (<code>Project Options &gt; Sessions</code>) click <code>Add</code> under <code>Session Handling Rules</code>.</li>
<li>Type in a rule description. E.g., <code>session-validation</code>.</li>
<li>Under <code>Rule Actions</code> click <code>Add</code> and select <code>Check session is valid</code>.





<span class="caption-wrapper">
  <img class="caption" src="05-session-rule-1.png" title="Session validation rule - 1" alt="Session validation rule - 1">
  <span class="caption-text">Session validation rule - 1</span>
</span>
</li>
<li>In the next screen, select <code>Issue current request</code> under <code>Make request(s) to validate session</code>. This tells Burp to modify the same request with the new header and resend it.</li>
<li>Under <code>Inspect response to determine session validity</code>, select <code>HTTP headers</code> and enter <code>401 Unauthorized</code> in the <code>Look for expression</code> field. This section determines how Burp detects invalid sessions. We are telling Burp that the session is invalid if <code>401 Unauthorized</code> appears in the response header.</li>
<li>Keep the rest of the options. We want exact match and case-insensitive.</li>
<li><code>Match indicates</code> must be set to <code>invalid session</code>. We are telling Burp how to detect invalid sessions after all.





<span class="caption-wrapper">
  <img class="caption" src="06-session-rule-2.png" title="Session validation rule - 2" alt="Session validation rule - 2">
  <span class="caption-text">Session validation rule - 2</span>
</span>
</li>
<li>Under <code>Define behavior dependent on session validity</code> check <code>If session is invalid, perform the action below</code>, check <code>Run a macro</code> and select the login macro.</li>
<li>Uncheck both <code>Update current request</code> boxes (doesn't matter in this example, we are not using cookies or parameters).</li>
<li>And finally, check <code>After running the macro, invoke a Burp extension action handler:</code> and select <code>Add Custom Header</code>. Response of the last request in the macro is passed to <code>Add Custom Header</code>. The extension extract sthe token using the regex (remember the match group) and adds it as a header to the request.





<span class="caption-wrapper">
  <img class="caption" src="07-session-rule-3.png" title="Session validation rule - 3" alt="Session validation rule - 3">
  <span class="caption-text">Session validation rule - 3</span>
</span>
</li>
<li>Press <code>Ok</code> and we're back at the first screen. Now we need to select the scope.</li>
<li>Click the <code>scope</code> tab and select any tool that needs this rule under <code>Tools Scope</code>. We will go with the default.</li>
<li>Under <code>URL Scope</code> select <code>Use suite scope</code>. We will set it later.





<span class="caption-wrapper">
  <img class="caption" src="09-session-rule-4.png" title="Setting scope" alt="Setting scope">
  <span class="caption-text">Setting scope</span>
</span>
</li>
</ol>

<h2 id="alternate-session-handling-rule">Alternate Session Handling Rule</h2>

<p>Instead of detecting the session, we can use an easier rule and run the macro and add the header to every request. I went with the more complicated process because I wanted to practice setting it up.</p>

<ol>
<li>The alternate rule is the same in every aspect, except the <code>Rule Actions</code> which is <code>Add (button) &gt; Run a Macro</code>.</li>
<li>Select the macro.</li>
<li>Uncheck both update checkboxes.</li>
<li>Enable <code>After running the macro</code> and select <code>Add Custom Header</code>.





<span class="caption-wrapper">
  <img class="caption" src="10-alternate-rule.png" title="Alternate rule" alt="Alternate rule">
  <span class="caption-text">Alternate rule</span>
</span>
</li>
</ol>

<h2 id="setting-the-scope">Setting the Scope</h2>

<p>In this example, we do not have to set the scope. But usually, we want to only operate in a specific scope. In my VM, the address is <code>http://192.168.99.100:8000</code> so I added it in <code>Target &gt; Scope</code> tab. I also excluded the login and logout API endpoints.</p>






<span class="caption-wrapper">
  <img class="caption" src="11-scope.png" title="Scope" alt="Scope">
  <span class="caption-text">Scope</span>
</span>


<h1 id="burp-in-action">Burp in Action</h1>

<p>Now it's time to see the fruit of our labor. Right click the request to <code>http://192.168.99.100:8000/api/v1/advertisements/</code> in Burp history and send it to Repeater. Click <code>Send</code> and see the header added to the request and get a valid response. It's empty but it's valid.</p>






<span class="caption-wrapper">
  <img class="caption" src="12-burp-in-action.gif" title="Burp in Action" alt="Burp in Action">
  <span class="caption-text">Burp in Action</span>
</span>


<p>Tune in for the next section, where I talk about using Burp's sitemap comparison.</p>

<!-- Links -->
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Dec 11, 2018</time>
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://localhost:1313/blog/2018-12-04-cheap-integrity-checks-with-head/" title="Cheap Integrity Checks with HEAD">Cheap Integrity Checks with HEAD</a>
    

    
      <a class="basic-alignment right" href="http://localhost:1313/blog/2018-12-17-tiredful-api-part-2-comparing-site-maps-with-burp/" title="Tiredful API - Part 2 - Comparing Site Maps with Burp">Tiredful API - Part 2 - Comparing Site Maps with Burp</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "parsiya" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Who am I?</h1>
    

    <p>
      
        <p>I am Pitchaimuthu Muthaiya, a senior security engineer.</p>

<p>I write about application tamil words and roots of words.</p>

<p>Click on <a href="/about/">About Me!</a> to know more.</p>

      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" rel="noopener noreferrer" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
      
        <a target="_blank" rel="noopener noreferrer" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-keybase fa-3x"></i></a> 
      
      <a target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/parsiya" title="https://www.linkedin.com/in/parsiya"><i class="fa fa-linkedin fa-3x"></i></a>
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Collections</h1>
        
        
          <li>
            <a href="http://localhost:1313/categories/thick-client-proxying/" title="Thick Client Proxying" >Thick Client Proxying</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/writeup/" title="CTFs/Writeups" >CTFs/Writeups</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/attack-surface-analysis/" title="Attack Surface Analysis" >Attack Surface Analysis</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/bug-bounty/" title="Bug Bounty" >Bug Bounty</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/go/" title="Go/Golang" >Go/Golang</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/blockchain/" title="Blockchain" >Blockchain</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/burp-extension/" title="Burp Extension Development" >Burp Extension Development</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/automation/" title="Automation" >Automation</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/reverse-engineering/" title="Reverse Engineering" >Reverse Engineering</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/crypto/" title="Crypto(graphy)" >Crypto(graphy)</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/winappdbg/" title="WinAppDbg" >WinAppDbg</a>
          </li>
        
          <li>
            <a href="https://awsome.pw" title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability" >AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a>
          </li>
        
      </section>
    
  

  
  
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2021 Parsia - <a href="http://localhost:1313/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    



    
    
    

    
  </body>
</html>

