<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>WinAppDbg - Part 2 - Function Hooking and Others</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="http://localhost:1313/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="[Parsia Hakimian Parsiya infosec information security]">
  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.83.1" />

  
  

  
  
    

  
    <meta name="twitter:card" content="summary"/>
  
  
  <meta name="twitter:title" content="WinAppDbg - Part 2 - Function Hooking and Others"/>
  <meta name="twitter:description" content="In part one we talked about the basics of WinAppDbg. In this part we are going to learn a few new things:


I wrote a simple python module to simplify my use of WinAppDbg. It will most likely be modified later, but I have included a version that works with the tutorials at:


https://github.com/parsiya/Parsia-Code/tree/master/winappdbg
We do not need to type the full filename anymore if the executable is in PATH. Note Run Line (win&#43;r) pulls stuff from more locations than PATH, so we cannot call chrome.exe. I have written about it here.

DLL enumeration: We&#39;re going to implement one of procmon&#39;s features.
Process/Thread tracing: Another procmon feature.
Function Hooking: It&#39;s very easy in WinAppDbg and we will learn how to do it a couple of different ways.


We will hook pre-TLS encryption data for Internet Explorer and Firefox to hack the Gibson.



Copy this directory https://github.com/parsiya/Parsia-Code/tree/master/winappdbg to your VM and let&#39;s go."/>
  
  <meta name="twitter:domain" content="parsiya.net"/>
  <meta name="twitter:creator" content="@CryptoGangsta"/>

  

  
  



</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="http://localhost:1313/">அஃக</a></h1>
    <h2>தமிழின் பெரிய சொற்தொகுப்பு</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="http://localhost:1313/about/">» About Me!</option>
      
        <option value="http://localhost:1313/letters/">» எழுத்து</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="http://localhost:1313/about/" title="About Me!"  target="_blank"  rel="noopener noreferrer">About Me!</a></li>
    
  
    
      <li><a href="http://localhost:1313/letters/" title="எழுத்து"  target="_blank"  rel="noopener noreferrer">எழுத்து</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="http://localhost:1313/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:http://localhost:1313/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Nov 11, 2017
     - 23 minute read 
     - <a href="http://localhost:1313/blog/2017-11-11-winappdbg-part-2-function-hooking-and-others/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="http://localhost:1313/categories/winappdbg/">winappdbg </a><a class="label" href="http://localhost:1313/categories/reverse-engineering/">reverse engineering </a>
    
  </p>
  <h1 class="entry-title">
     WinAppDbg - Part 2 - Function Hooking and Others 
  </h1>
</header>


        <div class="entry-content">
          
          
          
            <nav id="TableOfContents">
<ul>
<li><a href="#eventhandler-class">EventHandler Class</a></li>
<li><a href="#08-not-procmon-enumerating-loaded-modules">08 - Not Procmon - Enumerating Loaded Modules</a>
<ul>
<li><a href="#dll-load">dll_load</a></li>
<li><a href="#get-size-and-get-entry-point-invalid-handle-errors">get_size() and get_entry_point() Invalid Handle Errors</a></li>
</ul></li>
<li><a href="#09-not-procmon-tracing-processes-and-threads">09 - Not Procmon - Tracing Processes and Threads</a></li>
<li><a href="#10-basic-hooking-with-debug-hook-function">10 - Basic Hooking with debug.hook_function()</a>
<ul>
<li><a href="#function-signatures">Function Signatures</a></li>
<li><a href="#event-debug-hook-function">event.debug.hook_function()</a></li>
<li><a href="#pre-callback-functions">Pre Callback Functions</a></li>
<li><a href="#post-callback-functions">Post Callback Functions</a></li>
<li><a href="#hooking-in-action">Hooking in Action</a></li>
</ul></li>
<li><a href="#11-easier-hooking-via-apihooks">11 - Easier Hooking via apiHooks</a>
<ul>
<li><a href="#apihooks">apiHooks</a></li>
<li><a href="#apihooks-in-action">apiHooks in Action</a></li>
</ul></li>
<li><a href="#12-not-echo-mirage-hooking-ie-part-1">12 - Not Echo Mirage - Hooking IE - Part 1</a>
<ul>
<li><a href="#what-to-hook">What to Hook?</a></li>
<li><a href="#httpsendrequest">HttpSendRequest</a></li>
<li><a href="#hooking-ie">Hooking IE</a></li>
</ul></li>
<li><a href="#13-not-echo-mirage-hooking-ie-part-2">13 - Not Echo Mirage - Hooking IE - Part 2</a>
<ul>
<li><a href="#httpopenrequest">HttpOpenRequest</a></li>
<li><a href="#hooking-more-ie">Hooking more IE</a></li>
</ul></li>
<li><a href="#14-not-echo-mirage-firefox">14 - Not Echo Mirage - Firefox</a>
<ul>
<li><a href="#pr-write-in-rust">PR_Write (in Rust)</a></li>
<li><a href="#where-is-pr-write">Where is PR_Write?</a></li>
<li><a href="#null-terminated-strings-vs-random-buffer">Null-Terminated Strings vs. Random Buffer</a></li>
<li><a href="#firefox-in-action">Firefox in Action</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav>
          
          <p>In <a href="http://localhost:1313/blog/2017-11-09-winappdbg-part-1-basics/" title="WinAppDbg - Part 1 - Basics" rel="nofollow" target="_blank">part one</a> we talked about the basics of WinAppDbg. In this part we are going to learn a few new things:</p>

<ul>
<li>I wrote a <a href="https://github.com/parsiya/WinAppUtil" title="WinAppDbg repository on Github" rel="nofollow" target="_blank">simple python module</a> to simplify my use of WinAppDbg. It will most likely be modified later, but I have included a version that works with the tutorials at:

<ul>
<li><a href="https://github.com/parsiya/Parsia-Code/tree/master/winappdbg" title="WinAppDbg code in Parsia-Code" rel="nofollow" target="_blank">https://github.com/parsiya/Parsia-Code/tree/master/winappdbg</a></li>
<li>We do not need to type the full filename anymore if the executable is in PATH. Note Run Line (<code>win+r</code>) pulls stuff from more locations than PATH, so we cannot call <code>chrome.exe</code>. I have written about it <a href="http://localhost:1313/blog/2017-10-23-run-line-vs.-cmd-vs.-powershell/" title="Run Line vs. cmd vs. PowerShell" rel="nofollow" target="_blank">here</a>.</li>
</ul></li>
<li><strong>DLL enumeration</strong>: We're going to implement one of procmon's features.</li>
<li><strong>Process/Thread tracing</strong>: Another procmon feature.</li>
<li><strong>Function Hooking</strong>: It's very easy in WinAppDbg and we will learn how to do it a couple of different ways.

<ul>
<li>We will hook pre-TLS encryption data for Internet Explorer and Firefox to hack the Gibson.</li>
</ul></li>
</ul>

<p>Copy this directory <a href="https://github.com/parsiya/Parsia-Code/tree/master/winappdbg" title="WinAppDbg code in Parsia-Code" rel="nofollow" target="_blank">https://github.com/parsiya/Parsia-Code/tree/master/winappdbg</a> to your VM and let's go.</p>

<p>Moving forward, the <code>main</code> function is not going to change. It is now re-written using <code>WinAppUtil</code> but the functionality has not changed.</p>

<h1 id="eventhandler-class">EventHandler Class</h1>

<p>WinAppDbg uses callback methods for handling debugging events. In short, we can pass a class of type <code>winappdbg.EventHandler</code> to the <code>Debug</code> constructor at creation. When a certain event occurs during the execution, a method in the EventHandler class is called. Inside that method, we can write code that does something and &quot;handle&quot; that event.</p>

<p>Here's how we create and use such a class:</p>





<figure class="code">
  <figcaption>
  	<span>Simple EventHandler Usage</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">import</span> winappdbg

<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    This is the event handler class.
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">load_dll</span>(<span style="color:#268bd2">self</span>, event):
        <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">        This function is called when a new DLL is loaded.
</span><span style="color:#2aa198">        &#34;&#34;&#34;</span>

        <span style="color:#586e75"># do something with the event object</span>

<span style="color:#586e75"># Inside main</span>
debug <span style="color:#719e07">=</span> winappdbg<span style="color:#719e07">.</span>Debug(DebugEvents(), bKillOnExit<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)
debug<span style="color:#719e07">.</span>loop()</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>We can define quite a few events. Things like <code>create_process</code>, <code>create_thread</code> and <code>exception</code> (useful for catching crashes and other errors). Mario enumerates and explains them in <a href="https://winappdbg.readthedocs.io/en/latest/Debugging.html#the-eventhandler-class" title="The EventHandler class - WinAppDbg documentation" rel="nofollow" target="_blank">the docs</a> much better than I can do.</p>

<p>We can also define custom breakpoints and handlers in this class (and outside). We will see how to use them later.</p>

<p>Like always, we can learn much by reading the source. The source for EventHandler is at <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py" rel="nofollow" target="_blank">event.py</a>.</p>

<h1 id="08-not-procmon-enumerating-loaded-modules">08 - Not Procmon - Enumerating Loaded Modules</h1>

<p>You might have seen the procmon filter <code>load image</code> that lists DLLs loaded by the process. We can even grab a handle to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa813706(v=vs.85).aspx" title="Process Environment Block structure - MSDN" rel="nofollow" target="_blank">Process Environment Block</a> and read them from the linked-list in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa813708(v=vs.85).aspx" title="PEB_LDR_DATA structure - MSDN" rel="nofollow" target="_blank">PEB_LDR_DATA</a>. We can do it with WinAppDbg using the <code>load_dll</code> callback.</p>





<figure class="code">
  <figcaption>
  	<span>08-NotProcmon-LoadedModules.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">import</span> winappdbg
<span style="color:#719e07">import</span> argparse
<span style="color:#719e07">import</span> winapputil


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">load_dll</span>(<span style="color:#268bd2">self</span>, event):
        <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">        Called when a new module is loaded.
</span><span style="color:#2aa198">        &#34;&#34;&#34;</span>
        module <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_module()

        logstring <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Loaded DLL:</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Name: </span><span style="color:#2aa198">%s</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Filename: </span><span style="color:#2aa198">%s</span><span style="color:#cb4b16">\n</span><span style="color:#2aa198">Base Addr: </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> \
            (module<span style="color:#719e07">.</span>get_name(), module<span style="color:#719e07">.</span>get_filename(), <span style="color:#b58900">hex</span>(module<span style="color:#719e07">.</span>get_base()))

        mylogger<span style="color:#719e07">.</span>log_text(logstring)


<span style="color:#586e75"># ---------------</span>

<span style="color:#719e07">def</span> <span style="color:#268bd2">main</span>():
    <span style="color:#719e07">...</span></code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<h2 id="dll-load">dll_load</h2>

<p>The <code>event</code> object is passed to the method when a DLL is loaded. First we get the <code>module</code> object. It contains information about the DLL that is being loaded. For all module methods see <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/module.py#L75" rel="nofollow" target="_blank">module.py</a>.</p>

<p>Let's look at the output for <code>calc.exe</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python <span style="color:#2aa198">08</span><span style="color:#719e07">-</span>NotProcmon<span style="color:#719e07">-</span>LoadedModules<span style="color:#719e07">.</span>py <span style="color:#719e07">-</span>r calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0894</span>] Starting calc
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0904</span>]
Loaded DLL:
Name: ntdll
Filename: ntdll<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x77ca0000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">276</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: kernel32
Filename: C:\Windows\system32\kernel32<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x75ee0000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">280</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: kernelbase
Filename: C:\Windows\system32\KERNELBASE<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x75bd0000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">284</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: shell32
Filename: C:\Windows\system32\SHELL32<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x76970000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">288</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: msvcrt
Filename: C:\Windows\system32\msvcrt<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x76130000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">292</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: shlwapi
Filename: C:\Windows\system32\SHLWAPI<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x76910000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">296</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: gdi32
Filename: C:\Windows\system32\GDI32<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x764e0000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">300</span><span style="color:#719e07">&gt;</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">25</span>:<span style="color:#2aa198">51.0914</span>]
Loaded DLL:
Name: user32
Filename: C:\Windows\system32\USER32<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x778f0000</span>
<span style="color:#719e07">&lt;</span>FileHandle: <span style="color:#2aa198">304</span><span style="color:#719e07">&gt;</span>
<span style="color:#719e07">...</span></code></pre></div>
<p>Who knew calculator loads all these modules.</p>

<p>Procmon with the following filters shows we got the right info:</p>

<ul>
<li><code>Process Name is calc.exe</code></li>
<li><code>Operation is Load Image</code></li>
</ul>






<span class="caption-wrapper">
  <img class="caption" src="/images/2017/winappdbg-2/01-procmon-loadimage.png" title="Procmon Load Image filter" alt="Procmon Load Image filter">
  <span class="caption-text">Procmon Load Image filter</span>
</span>


<p>If the image looks small, right click and open in a new tab.</p>

<h2 id="get-size-and-get-entry-point-invalid-handle-errors">get_size() and get_entry_point() Invalid Handle Errors</h2>

<p>Not all <code>module</code> methods work, for example <code>get_size</code> and <code>get_entry_point</code> do not. Uncomment the line for calling <code>get_size()</code> in our code to get this error:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python <span style="color:#2aa198">08</span><span style="color:#719e07">-</span>NotProcmon<span style="color:#719e07">-</span>LoadedModules<span style="color:#719e07">.</span>py <span style="color:#719e07">-</span>r calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">17</span>:<span style="color:#2aa198">39</span>:<span style="color:#2aa198">20.0900</span>] Starting calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">17</span>:<span style="color:#2aa198">39</span>:<span style="color:#2aa198">20.0900</span>]
Loaded DLL:
Name: ntdll
Filename: ntdll<span style="color:#719e07">.</span>dll
Base Addr: <span style="color:#2aa198">0x77ca0000</span>
C:\Python27\lib\site<span style="color:#719e07">-</span>packages\winappdbg\module<span style="color:#719e07">.</span>py:<span style="color:#2aa198">294</span>: <span style="color:#cb4b16">RuntimeWarning</span>: Cannot get 
size <span style="color:#719e07">and</span> entry point of module ntdll, reason: The handle <span style="color:#719e07">is</span> invalid<span style="color:#719e07">.</span>
  <span style="color:#719e07">%</span> (<span style="color:#268bd2">self</span><span style="color:#719e07">.</span>get_name(), e<span style="color:#719e07">.</span>strerror), <span style="color:#cb4b16">RuntimeWarning</span>)</code></pre></div>
<p>At this point I am not exactly sure why we get this error. I dug around and found some really interesting things about how module are loaded on Windows. In short, WinAppDbg uses <a href="https://msdn.microsoft.com/en-us/library/ms683201(v=VS.85).aspx" title="GetModuleInformation - MSDN" rel="nofollow" target="_blank">GetModuleInformation</a> and according to the MSDN article it cannot get info on files &quot;that were loaded with the <code>LOAD_LIBRARY_AS_DATAFILE</code> flag.&quot; We can see it in <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/module.py#L260" rel="nofollow" target="_blank">get_size()</a> source (scroll down to line 280 to see <code>GetModuleInformation</code> called) and <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/win32/psapi.py#L330" rel="nofollow" target="_blank">winappdbg.win32.GetModuleInformation</a>.</p>

<p>However I found <a href="https://blogs.msdn.microsoft.com/oldnewthing/20150716-00/?p=45131" title="Why do I get ERROR_INVALID_HANDLE from GetModuleFileNameEx when I know the process handle is valid? - The Old New Thing" rel="nofollow" target="_blank">this MSDN blog entry</a> by Raymond Chen<sup class="footnote-ref" id="fnref:raymond-1"><a href="#fn:raymond-1">1</a></sup> where he explains why we get an invalid handle error when calling <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683198(v=vs.85).aspx" title="GetModuleFileNameEx - MSDN" rel="nofollow" target="_blank">GetModuleFileNameEx</a>. Because the module has not been executed(??) yet, there's almost nothing at the location that the handle is pointing to (that's my understanding but I could be wrong). I think we are facing the same issue here, because <code>load_dll</code> is called right before DLL is loaded. This is something I need to look at later.</p>

<h1 id="09-not-procmon-tracing-processes-and-threads">09 - Not Procmon - Tracing Processes and Threads</h1>

<p>We can also trace processes and threads. This code implements this procmon functionality:</p>





<figure class="code">
  <figcaption>
  	<span>09-NotProcmon-CreateProcess.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">create_process</span>(<span style="color:#268bd2">self</span>, event):
        process  <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        pid      <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_pid()
        <span style="color:#586e75"># pid    = process.get_pid()</span>
        filename <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>get_filename()

        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;CreateProcess </span><span style="color:#2aa198">%d</span><span style="color:#2aa198"> - </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (pid, filename))

    <span style="color:#719e07">def</span> <span style="color:#268bd2">exit_process</span>(<span style="color:#268bd2">self</span>, event):
        process  <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        pid      <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_pid()
        <span style="color:#586e75"># pid    = process.get_pid()</span>
        filename <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>get_filename()

        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;ExitProcess </span><span style="color:#2aa198">%d</span><span style="color:#2aa198"> - </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (pid, filename))

    <span style="color:#719e07">def</span> <span style="color:#268bd2">create_thread</span>(<span style="color:#268bd2">self</span>, event):
        process  <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        thread   <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_thread()

        tid  <span style="color:#719e07">=</span> thread<span style="color:#719e07">.</span>get_tid()
        name <span style="color:#719e07">=</span> thread<span style="color:#719e07">.</span>get_name()

        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;CreateThread </span><span style="color:#2aa198">%d</span><span style="color:#2aa198"> - </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (tid, name))

    <span style="color:#719e07">def</span> <span style="color:#268bd2">exit_thread</span>(<span style="color:#268bd2">self</span>, event):
        process  <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        thread   <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_thread()

        tid  <span style="color:#719e07">=</span> thread<span style="color:#719e07">.</span>get_tid()
        name <span style="color:#719e07">=</span> thread<span style="color:#719e07">.</span>get_name()

        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;ExitThread </span><span style="color:#2aa198">%d</span><span style="color:#2aa198"> - </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (tid, name))


<span style="color:#586e75"># ---------------</span>

<span style="color:#719e07">def</span> <span style="color:#268bd2">main</span>():
    <span style="color:#719e07">...</span></code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>We have created four callback methods in the EventHandler class. They trace creation and termination of processes/threads.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python <span style="color:#2aa198">09</span><span style="color:#719e07">-</span>NotProcmon<span style="color:#719e07">-</span>CreateProcess<span style="color:#719e07">.</span>py <span style="color:#719e07">-</span>r calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">09.0727</span>] Starting calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">09.0727</span>] CreateProcess <span style="color:#2aa198">3720</span> <span style="color:#719e07">-</span> C:\Windows\System32\calc<span style="color:#719e07">.</span>exe
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">09.0788</span>] CreateThread <span style="color:#2aa198">1688</span> <span style="color:#719e07">-</span> <span style="color:#268bd2">None</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">09.0798</span>] CreateThread <span style="color:#2aa198">2344</span> <span style="color:#719e07">-</span> <span style="color:#268bd2">None</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">12.0289</span>] ExitThread <span style="color:#2aa198">1688</span> <span style="color:#719e07">-</span> <span style="color:#268bd2">None</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">12.0289</span>] ExitThread <span style="color:#2aa198">2344</span> <span style="color:#719e07">-</span> <span style="color:#268bd2">None</span>
[<span style="color:#2aa198">21</span>:<span style="color:#2aa198">35</span>:<span style="color:#2aa198">12.0299</span>] ExitProcess <span style="color:#2aa198">3720</span> <span style="color:#719e07">-</span> C:\Windows\System32\calc<span style="color:#719e07">.</span>exe</code></pre></div>
<p>Procmon can display the same info using these five filters:</p>

<ul>
<li><code>Process Name is calc.exe</code></li>
<li><code>Operation is Process Start</code></li>
<li><code>Operation is Process Exit</code></li>
<li><code>Operation is Thread Create</code></li>
<li><code>Operation is Thread Exit</code></li>
</ul>






<span class="caption-wrapper">
  <img class="caption" src="/images/2017/winappdbg-2/02-procmon-trace.png" title="Tracing in procmon" alt="Tracing in procmon">
  <span class="caption-text">Tracing in procmon</span>
</span>


<h1 id="10-basic-hooking-with-debug-hook-function">10 - Basic Hooking with debug.hook_function()</h1>

<p>Enough with things we can already do with other tools. Let's hook functions. Hooking functions is pretty useful. For example they can <a href="http://localhost:1313/blog/2015-01-06-tales-from-the-crypto-leaking-aes-keys/#2-3-using-ltrace-to-find-the-key" title="Tales from the Crypto - Leaking encryption Keys - Using ltrace to Find the Key" rel="nofollow" target="_blank">leak AES keys</a> and tons of other useful information.</p>

<p>Unfortunately we do not have <code>ltrace</code> on Windows but we can hook functions pretty easily with WinAppDbg in a few ways.</p>

<p>In this example we are going to hook the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85).aspx" title="CreateFile - MSDN" rel="nofollow" target="_blank">CreateFile</a> Windows API calls from <code>kernel32</code> for <code>calc</code> and <code>notepad</code>.</p>





<figure class="code">
  <figcaption>
  	<span>10-BasicHook.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">from</span> winappdbg.win32 <span style="color:#719e07">import</span> PVOID, DWORD, HANDLE


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">load_dll</span>(<span style="color:#268bd2">self</span>, event):
        module <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_module()

        <span style="color:#719e07">if</span> module<span style="color:#719e07">.</span>match_name(<span style="color:#2aa198">&#34;kernel32.dll&#34;</span>):

            <span style="color:#586e75"># Resolve function addresses</span>
            address_CreateFileA <span style="color:#719e07">=</span> module<span style="color:#719e07">.</span>resolve(<span style="color:#2aa198">&#34;CreateFileA&#34;</span>)
            address_CreateFileW <span style="color:#719e07">=</span> module<span style="color:#719e07">.</span>resolve(<span style="color:#2aa198">&#34;CreateFileW&#34;</span>)

            <span style="color:#586e75"># Types are here</span>
            <span style="color:#586e75"># https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/win32/defines.py#L380</span>
            sig_CreateFileA <span style="color:#719e07">=</span> (PVOID, DWORD, DWORD, PVOID, DWORD, DWORD, HANDLE)
            sig_CreateFileW <span style="color:#719e07">=</span> (PVOID, DWORD, DWORD, PVOID, DWORD, DWORD, HANDLE)

            pid <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_pid()

            <span style="color:#586e75"># Hook function(pid, address, preCB, postCB, paramCount, signature)</span>
            <span style="color:#586e75"># https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/breakpoint.py#L3969</span>
            event<span style="color:#719e07">.</span>debug<span style="color:#719e07">.</span>hook_function(pid, address_CreateFileA,
                                      preCB<span style="color:#719e07">=</span>pre_CreateFileA,
                                      signature<span style="color:#719e07">=</span>sig_CreateFileA)

            event<span style="color:#719e07">.</span>debug<span style="color:#719e07">.</span>hook_function(pid, address_CreateFileW,
                                      preCB<span style="color:#719e07">=</span>pre_CreateFileW,
                                      signature<span style="color:#719e07">=</span>sig_CreateFileW)

            <span style="color:#586e75"># Another way of setting up hooks without signature</span>

            <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">            event.debug.hook_function(pid, address_CreateFileA,
</span><span style="color:#2aa198">                                      preCB=pre_CreateFileA,
</span><span style="color:#2aa198">                                      paramCount=7)
</span><span style="color:#2aa198">
</span><span style="color:#2aa198">            event.debug.hook_function(pid, address_CreateFileW,
</span><span style="color:#2aa198">                                      preCB=pre_CreateFileW,
</span><span style="color:#2aa198">                                      paramCount=7)
</span><span style="color:#2aa198">            &#34;&#34;&#34;</span>

<span style="color:#586e75"># ---------------</span>

<span style="color:#719e07">def</span> <span style="color:#268bd2">main</span>():
    <span style="color:#719e07">...</span></code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>That's quite a lot of code but it's mostly boilerplate. Let's break it down.</p>

<p>First we are importing some symbols from <code>winappdbg.win32</code>. We will use them in a bit. We can see all of these symbols in <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/win32/defines.py#L380" rel="nofollow" target="_blank">defines.py</a>.</p>

<p>Inside <code>dll_load</code>, we check if we are loading <code>kernel32.dll</code>. If so, we call <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/module.py#L696" rel="nofollow" target="_blank">module.resolve()</a> for <code>CreateFileA</code> and <code>CreateFileW</code>. These return the address for exported functions in the target process<sup class="footnote-ref" id="fnref:dll-land-addr"><a href="#fn:dll-land-addr">2</a></sup>. A is the ANSI and W (Wide) is the UTF-16 version of the <code>CreateFile</code> function<sup class="footnote-ref" id="fnref:ansi-wide-msdn"><a href="#fn:ansi-wide-msdn">3</a></sup>.</p>

<h2 id="function-signatures">Function Signatures</h2>

<p>Then we create a signature for each hooked function. The signature is like a function prototype from C/C++. It tells WinAppDbg the type and number of arguments for each function.</p>

<p>This is <code>CreateFile</code><sup class="footnote-ref" id="fnref:asm-highlight"><a href="#fn:asm-highlight">4</a></sup>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">HANDLE</span> <span style="color:#cb4b16">WINAPI</span> <span style="color:#cb4b16">CreateFile</span>(
  <span style="color:#268bd2">_In_</span>     <span style="color:#cb4b16">LPCTSTR</span>               <span style="color:#cb4b16">lpFileName</span>,
  <span style="color:#268bd2">_In_</span>     <span style="color:#cb4b16">DWORD</span>                 <span style="color:#cb4b16">dwDesiredAccess</span>,
  <span style="color:#268bd2">_In_</span>     <span style="color:#cb4b16">DWORD</span>                 <span style="color:#cb4b16">dwShareMode</span>,
  <span style="color:#268bd2">_In_opt_</span> <span style="color:#cb4b16">LPSECURITY_ATTRIBUTES</span> <span style="color:#cb4b16">lpSecurityAttributes</span>,
  <span style="color:#268bd2">_In_</span>     <span style="color:#cb4b16">DWORD</span>                 <span style="color:#cb4b16">dwCreationDisposition</span>,
  <span style="color:#268bd2">_In_</span>     <span style="color:#cb4b16">DWORD</span>                 <span style="color:#cb4b16">dwFlagsAndAttributes</span>,
  <span style="color:#268bd2">_In_opt_</span> <span style="color:#cb4b16">HANDLE</span>                <span style="color:#cb4b16">hTemplateFile</span>
);</code></pre></div>
<p>So our signature for both <code>CreateFile</code> functions is <code>(PVOID, DWORD, DWORD, PVOID, DWORD, DWORD, HANDLE)</code>. Hungarian notation rocks!</p>

<p>When creating signatures, <strong>use PVOID for all pointers</strong>. Otherwise according to the docs, ctypes become too helpful and ruin everything by trying &quot;to access the memory pointed to by them... and crash[ing], since those pointers only work in the debugged process..)&quot;.</p>

<h2 id="event-debug-hook-function">event.debug.hook_function()</h2>

<p>Next we hook each function using <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/breakpoint.py#L3969" rel="nofollow" target="_blank">event.debug.hook_function</a> like this<sup class="footnote-ref" id="fnref:hook-breakpoint"><a href="#fn:hook-breakpoint">5</a></sup>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">event.debug.hook_function</span>(<span style="color:#cb4b16">pid</span>, <span style="color:#cb4b16">address_CreateFileW</span>, 
                          <span style="color:#cb4b16">preCB</span>=<span style="color:#cb4b16">pre_CreateFileW</span>,
                          <span style="color:#268bd2">postCB</span>=<span style="color:#cb4b16">post_CreateFileW</span>,
                          <span style="color:#268bd2">signature</span>=<span style="color:#cb4b16">sig_CreateFileW</span>)</code></pre></div>
<ul>
<li><code>pid</code> is the current process ID. We are passing <code>event.get_pid()</code>.</li>
<li><code>address_CreateFileW</code> is the <code>CreateFileW</code> function address in process memory.</li>
<li><code>preCB</code> is name of the pre-execution callback function for this breakpoint. This function could be anywhere.</li>
<li><code>postCB</code> is called when the hooked function returns.</li>
<li><code>signature</code> is the signature we just created.</li>
<li>Instead of <code>signature</code> we can pass <code>paramCount</code> which is just an int containing the number of parameters (starting from 1) which is <code>7</code> here.

<ul>
<li>According to <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/breakpoint.py#L1107-L1112" rel="nofollow" target="_blank">source code</a>, using signature is better for cross-platform functionality. <code>paramCount</code> is used to retrieve items from stack and read dwords in 32-bit processes. This might pose some issues for 64-bit processes because first four parameters are stored in registers and pointers are qwords (64-bits) on Windows 64-bit<sup class="footnote-ref" id="fnref:64-bit"><a href="#fn:64-bit">6</a></sup>.</li>
</ul></li>
</ul>

<h2 id="pre-callback-functions">Pre Callback Functions</h2>

<p>Next is <code>pre_CreateFileW</code>. The first two arguments for each callback function are always <code>event</code> and <code>ra</code> (return address) and <code>self</code> if needed.</p>





<figure class="code">
  <figcaption>
  	<span>Pre Callback Functions</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#586e75"># Callback functions</span>
<span style="color:#586e75"># -------------------</span>

<span style="color:#586e75"># Callback function parameters are always</span>
<span style="color:#586e75"># (event, ra (return address), then function parameters)</span>
<span style="color:#586e75"># self is first if part of the eventhandler class</span>


<span style="color:#719e07">def</span> <span style="color:#268bd2">pre_CreateFileW</span>(event, ra, lpFileName, dwDesiredAccess, dwShareMode,
                    lpSecurityAttributes, dwCreationDisposition,
                    dwFlagsAndAttributes, hTemplateFile):

    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    This will be called as soon as we enter the function and before the
</span><span style="color:#2aa198">    function stack frame is created.
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()

    <span style="color:#586e75"># Suspend the process because why not</span>
    process<span style="color:#719e07">.</span>suspend()

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Hit kernel32!CreateFileW&#34;</span>)

    <span style="color:#586e75"># 32-bit so all parameters are on stack</span>

    <span style="color:#586e75"># In case you want a pointer to the top of the stack</span>
    <span style="color:#586e75"># thread = event.get_thread()</span>

    <span style="color:#586e75"># All memory read stuff are at</span>
    <span style="color:#586e75"># https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/process.py#L125</span>

    <span style="color:#586e75"># fUnicode=True because we are in the Wide or Unicode version of the API</span>
    myFileName <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpFileName, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;lpFilename: </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (myFileName))

    <span style="color:#586e75"># Resume the process</span>
    process<span style="color:#719e07">.</span>resume()


<span style="color:#719e07">def</span> <span style="color:#268bd2">pre_CreateFileA</span>(event, ra, lpFileName, dwDesiredAccess, dwShareMode,
                    lpSecurityAttributes, dwCreationDisposition,
                    dwFlagsAndAttributes, hTemplateFile):

    process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()

    <span style="color:#586e75"># Suspend the process because why not</span>
    process<span style="color:#719e07">.</span>suspend()

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Hit kernel32!CreateFileA&#34;</span>)

    <span style="color:#586e75"># fUnicode=False because we are in the ANSI version</span>
    myFileName <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpFileName, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">False</span>)

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;lpFilename: </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (myFileName))

    process<span style="color:#719e07">.</span>resume()</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>First we suspend the process and log some text to indicate we are inside the function.</p>

<p>Now we can read each argument. We are interested in <code>lpFileName</code> which is a long pointer to a UTF-16 string (lpsz == long pointer to null-terminated [zeroed] string). WinAppDbg comes with a <a href="https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/process.py#L125" rel="nofollow" target="_blank">lot of methods</a> for reading and writing process memory. In this case we want to read a UTF-16 string so we call <code>process.peek_string(lpFileName, fUnicode=True)</code>. In the ANSI version we do the same but with <code>fUnicode=False</code>.</p>

<p>After printing <code>lpFileName</code>, we resume the process and the callback function returns.</p>

<h2 id="post-callback-functions">Post Callback Functions</h2>

<p>Post callback functions are similar to pre ones. They only have two arguments <code>([self], event, retval)</code>. They are called just after the function returns and allow us to manipulate return values.</p>





<figure class="code">
  <figcaption>
  	<span>Post Callback Functions</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">def</span> <span style="color:#268bd2">post_CreateFileW</span>(event, retval):

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Leaving kernel32!CreateFileW&#34;</span>)
    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Return value: </span><span style="color:#2aa198">%x</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (retval))


<span style="color:#719e07">def</span> <span style="color:#268bd2">post_CreateFileA</span>(event, retval):

    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Leaving kernel32!CreateFileA&#34;</span>)
    mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Return value: </span><span style="color:#2aa198">%x</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (retval))</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<h2 id="hooking-in-action">Hooking in Action</h2>

<p>Now we can run it on <code>calc</code> and see the results:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python <span style="color:#2aa198">10</span><span style="color:#719e07">-</span>BasicHook<span style="color:#719e07">.</span>py <span style="color:#719e07">-</span>r calc
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">12</span>:<span style="color:#2aa198">15.0736</span>] Starting calc
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">12</span>:<span style="color:#2aa198">15.0796</span>] Hit kernel32!CreateFileW
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">12</span>:<span style="color:#2aa198">15.0796</span>] lpFilename: C:\Windows\Fonts\staticcache<span style="color:#719e07">.</span>dat
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">12</span>:<span style="color:#2aa198">15.0796</span>] Leaving kernel32!CreateFileW
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">12</span>:<span style="color:#2aa198">15.0796</span>] Return value: c4</code></pre></div>
<p>And in procmon with these filters:</p>

<ul>
<li><code>Process Name is calc.exe</code></li>
<li><code>Operation is ReadFile</code>

<ul>
<li>If you have enabled <code>Filter (menu) &gt; Enable Advanced Output</code>, use <code>IRP_MJ_READ</code> instead of <code>ReadFile</code>.</li>
</ul></li>
</ul>






<span class="caption-wrapper">
  <img class="caption" src="/images/2017/winappdbg-2/03-procmon-readfile.png" title="Procmon ReadFile filter" alt="Procmon ReadFile filter">
  <span class="caption-text">Procmon ReadFile filter</span>
</span>


<p>I am not going to post the <code>notepad</code> output here. Run the script with <code>-r notepad</code> and you will see a wall of text when you open a common file dialog to open a file or save.</p>

<p>For a similar example in the docs, see <a href="https://winappdbg.readthedocs.io/en/latest/Debugging.html#example-12-hooking-a-function" title="Example #12: hooking a function - WinAppDbg documentation" rel="nofollow" target="_blank">example 12 - hooking a function</a>.</p>

<h1 id="11-easier-hooking-via-apihooks">11 - Easier Hooking via apiHooks</h1>

<p>That was fun but we wrote a lot of boilerplate code. WinAppDbg offers a better way to hook functions through <code>apiHooks</code>.</p>





<figure class="code">
  <figcaption>
  	<span>11-BetterHook.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">from</span> winappdbg.win32 <span style="color:#719e07">import</span> PVOID, DWORD, HANDLE


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    <span style="color:#586e75"># Better hooking</span>
    <span style="color:#586e75"># https://winappdbg.readthedocs.io/en/latest/Debugging.html#example-9-intercepting-api-calls</span>

    apiHooks <span style="color:#719e07">=</span> {

        <span style="color:#586e75"># Hooks for the kernel32 library.</span>
        <span style="color:#2aa198">&#34;kernel32.dll&#34;</span>: [

            <span style="color:#586e75"># We have seen these before</span>
            <span style="color:#586e75"># Function       Signature</span>
            (<span style="color:#2aa198">&#34;CreateFileA&#34;</span>, (PVOID, DWORD, DWORD, PVOID, DWORD, DWORD, HANDLE)),
            (<span style="color:#2aa198">&#34;CreateFileW&#34;</span>, (PVOID, DWORD, DWORD, PVOID, DWORD, DWORD, HANDLE)),

            <span style="color:#586e75"># Can also pass parameter count</span>
            <span style="color:#586e75"># (&#34;CreateFileA&#34;, 6),</span>
            <span style="color:#586e75"># (&#34;CreateFileW&#34;, 6),</span>
        ],
    }

    <span style="color:#586e75"># Now we can simply define a method for each hooked API.</span>
    <span style="color:#586e75"># &#34;pre_&#34;  methods are called when entering the hooked function.</span>
    <span style="color:#586e75"># &#34;post_&#34; methods are called when returning from the hooked function.</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_CreateFileW</span>(<span style="color:#268bd2">self</span>, event, ra, lpFileName, dwDesiredAccess,
                        dwShareMode, lpSecurityAttributes, dwCreationDisposition,
                        dwFlagsAndAttributes, hTemplateFile):

        process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        myFileName <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpFileName, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;pre_CreateFileW opening file </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (myFileName))

    <span style="color:#719e07">def</span> <span style="color:#268bd2">post_CreateFileW</span>(<span style="color:#268bd2">self</span>, event, retval):
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Return value: </span><span style="color:#2aa198">%x</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> retval)

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_CreateFileA</span>(<span style="color:#268bd2">self</span>, event, ra, lpFileName, dwDesiredAccess,
                        dwShareMode, lpSecurityAttributes, dwCreationDisposition,
                        dwFlagsAndAttributes, hTemplateFile):

        process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()
        myFileName <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpFileName, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">False</span>)
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;pre_CreateFileA opening file </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (myFileName))

    <span style="color:#719e07">def</span> <span style="color:#268bd2">post_CreateFileA</span>(<span style="color:#268bd2">self</span>, event, retval):
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Return value: </span><span style="color:#2aa198">%x</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> retval)</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>This looks much easier and more straightforward (of course I am biased).</p>

<h2 id="apihooks">apiHooks</h2>

<p>Inside our EventHandler class we create a dictionary named <code>apiHooks</code>. DLL name is key and hooked functions (and their signatures) are values. I am hooking functions from one DLL it's possible to add multiple DLLs/functions quickly.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">apiHooks</span> = {

    <span style="color:#586e75"># Hooks for the kernel32 library.
</span><span style="color:#586e75"></span>    &#39;<span style="color:#268bd2">kernel32.dll</span>&#39;: [

        <span style="color:#586e75"># We have seen these before
</span><span style="color:#586e75"></span>        <span style="color:#586e75"># Function       Signature
</span><span style="color:#586e75"></span>        (&#39;<span style="color:#268bd2">CreateFileA</span>&#39;, (<span style="color:#cb4b16">PVOID</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">PVOID</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">HANDLE</span>)),
        (&#39;<span style="color:#268bd2">CreateFileW</span>&#39;, (<span style="color:#cb4b16">PVOID</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">PVOID</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">DWORD</span>, <span style="color:#cb4b16">HANDLE</span>)),

        <span style="color:#586e75"># Can also pass parameter count
</span><span style="color:#586e75"></span>        <span style="color:#586e75"># (&#39;CreateFileA&#39;, 6),
</span><span style="color:#586e75"></span>        <span style="color:#586e75"># (&#39;CreateFileW&#39;, 6),
</span><span style="color:#586e75"></span>    ],
}</code></pre></div>
<p>We can also pass parameter count instead of signature. I personally prefer signature because it's easier to keep track of argument types.</p>

<p>Then for each hooked functions we create two methods name <code>pre</code> and <code>post</code> like before (note method names are non-negotiable so don't go creative here).</p>

<h2 id="apihooks-in-action">apiHooks in Action</h2>

<p>And it works.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">$ python <span style="color:#2aa198">11</span><span style="color:#719e07">-</span>BetterHook<span style="color:#719e07">.</span>py <span style="color:#719e07">-</span>r calc
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">54</span>:<span style="color:#2aa198">01.0164</span>] Starting calc
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">54</span>:<span style="color:#2aa198">01.0213</span>] pre_CreateFileW opening <span style="color:#b58900">file</span> C:\Windows\Fonts\staticcache<span style="color:#719e07">.</span>dat
[<span style="color:#2aa198">00</span>:<span style="color:#2aa198">54</span>:<span style="color:#2aa198">01.0213</span>] Return value: c4</code></pre></div>
<p>For a similar example in docs see <a href="https://winappdbg.readthedocs.io/en/latest/Debugging.html#example-9-intercepting-api-calls" title="Example #9: intercepting API calls - WinAppDbg documentation" rel="nofollow" target="_blank">example 9: intercepting-api-calls</a>.</p>






<span class="caption-wrapper">
  <img class="caption" src="https://i.giphy.com/media/zcCGBRQshGdt6/giphy.gif" title="Eating your bandwith two megabytes at a time" alt="Eating your bandwith two megabytes at a time">
  <span class="caption-text">Eating your bandwith two megabytes at a time</span>
</span>


<p>Moving forward we will be using this method for hooking.</p>

<h1 id="12-not-echo-mirage-hooking-ie-part-1">12 - Not Echo Mirage - Hooking IE - Part 1</h1>

<p>Echo Mirage was an application that used function hooking to view and modify pre-encryption/pre-TLS traffic. Good luck finding a clean version of it :D. We are going to hook IE using WinAppDbg to just view payloads.</p>

<h2 id="what-to-hook">What to Hook?</h2>

<p>We learn from malware. They are the best. In this article titled <a href="https://thisissecurity.stormshield.com/2017/09/28/analyzing-form-grabber-malware-targeting-browsers/#t01" title="Analyzing a form-grabber malware - ThisIsSecurity" rel="nofollow" target="_blank">Analyzing a form-grabber malware</a>, there's a table that contains what this malware hooks<sup class="footnote-ref" id="fnref:no-anchor"><a href="#fn:no-anchor">7</a></sup>. This is the part we are interested in.</p>

<table>
<thead>
<tr>
<th>Browser</th>
<th>DLL</th>
<th>Function</th>
</tr>
</thead>

<tbody>
<tr>
<td>iexplore.exe</td>
<td>Wininet.dll</td>
<td>HttpSendRequestW/A</td>
</tr>

<tr>
<td>firefox.exe</td>
<td>nspr4.dll</td>
<td>PR_Write</td>
</tr>
</tbody>
</table>

<h2 id="httpsendrequest">HttpSendRequest</h2>

<p>For IE we need to hook <code>HttpSendRequestW</code> (not going to bother with the Ansi version on Win 7). According to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384247(v=vs.85).aspx" title="HttpSendRequest - MSDN" rel="nofollow" target="_blank">MSDN</a> it looks like this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">BOOL</span> <span style="color:#cb4b16">HttpSendRequest</span>(
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">HINTERNET</span> <span style="color:#cb4b16">hRequest</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   <span style="color:#cb4b16">lpszHeaders</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">DWORD</span>     <span style="color:#cb4b16">dwHeadersLength</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPVOID</span>    <span style="color:#cb4b16">lpOptional</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">DWORD</span>     <span style="color:#cb4b16">dwOptionalLength</span>
);</code></pre></div>
<p>We want to log the <code>lpOptional</code> parameter because it contains the <code>POST</code> and <code>PUT</code> payloads and most likely passwords (which this malware is interested in) are submitted via <code>POST</code>.</p>





<figure class="code">
  <figcaption>
  	<span>12-NotEchoMirage-IE-1.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">from</span> winappdbg.win32 <span style="color:#719e07">import</span> PVOID, DWORD, HANDLE


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    apiHooks <span style="color:#719e07">=</span> {

        <span style="color:#586e75"># Hooks for the wininet.dll library - note this is case-sensitive</span>
        <span style="color:#2aa198">&#39;wininet.dll&#39;</span>: [

            <span style="color:#586e75"># Function            Signature</span>
            (<span style="color:#2aa198">&#39;HttpSendRequestW&#39;</span>, (HANDLE, PVOID, DWORD, PVOID, DWORD)),
        ],
    }

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_HttpSendRequestW</span>(<span style="color:#268bd2">self</span>, event, ra, hRequest, lpszHeaders,
                             dwHeadersLength, lpOptional, dwOptionalLength):

        process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()

        <span style="color:#719e07">if</span> dwHeadersLength <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>:
            mylogger<span style="color:#719e07">.</span>log_text(winapputil<span style="color:#719e07">.</span>utils<span style="color:#719e07">.</span>get_line())
            mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;HttpSendRequestW&#34;</span>)

            headers <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpszHeaders, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)
            mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Headers </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (headers))

        <span style="color:#719e07">if</span> dwOptionalLength <span style="color:#719e07">!=</span> <span style="color:#2aa198">0</span>:
            <span style="color:#586e75"># This is not unicode - see the pointer name (lp vs. lpsz)</span>
            <span style="color:#586e75"># fUnicode is set to False (default) then</span>
            optional <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpOptional, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">False</span>)

            mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;Optional </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> (optional))
            mylogger<span style="color:#719e07">.</span>log_text(winapputil<span style="color:#719e07">.</span>utils<span style="color:#719e07">.</span>get_line())</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>Our code looks simple thanks to the <code>apiHooks</code> functionality.</p>

<p>In <code>pre_HttpSendRequestW</code> we are reading <code>lpszHeaders</code> and <code>lpOptional</code> (both are not Unicode) and print them.</p>

<h2 id="hooking-ie">Hooking IE</h2>

<p>Run IE (note it's not in PATH so you have to enter the full path) and go around the web, see headers (no cookies) and the occasional <code>POST</code> request (mostly ads). To see a <code>POST</code> request in action, head over to pastebin and submit a new paste:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">$</span> <span style="color:#cb4b16">python</span> <span style="color:#2aa198">12</span>-<span style="color:#cb4b16">NotEchoMirage-IE-1.py</span> -<span style="color:#cb4b16">r</span> &#34;<span style="color:#cb4b16">c</span>:\<span style="color:#cb4b16">Program</span> <span style="color:#cb4b16">Files</span>\<span style="color:#cb4b16">Internet</span> <span style="color:#cb4b16">Explorer</span>\<span style="color:#cb4b16">iexplore.exe</span>&#34;
...
[01:50:02<span style="color:#268bd2">.0115</span>] ---------------------------------------------------------------------------
[01:50:02<span style="color:#268bd2">.0115</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[01:50:02<span style="color:#268bd2">.0115</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Referer</span>: <span style="color:#cb4b16">https</span>://<span style="color:#cb4b16">pastebin.com</span>/
Accept-Language: <span style="color:#268bd2">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Content-Type</span>: <span style="color:#cb4b16">multipart</span>/<span style="color:#cb4b16">form-data</span><span style="color:#586e75">; boundary=---------------------------7e16a21104fe
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
[01:50:02<span style="color:#268bd2">.0115</span>] <span style="color:#cb4b16">Optional</span> -----------------------------<span style="color:#2aa198">7</span><span style="color:#cb4b16">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;csrf_token_post&#34;
</span><span style="color:#586e75"></span>
<span style="color:#268bd2">MTUxMDM4Mjk1N0g5d1d2TkJXZnNXUEk3UWdmTnlycXp2WHp3M0lJc1VG</span>
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;submit_hidden&#34;
</span><span style="color:#586e75"></span>
<span style="color:#268bd2">submit_hidden</span>
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;paste_code&#34;
</span><span style="color:#586e75"></span>
<span style="color:#268bd2">Random</span> <span style="color:#cb4b16">text</span> <span style="color:#cb4b16">in</span> <span style="color:#cb4b16">pastebin</span>
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;paste_format&#34;
</span><span style="color:#586e75"></span>
1
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;paste_expire_date&#34;
</span><span style="color:#586e75"></span>
<span style="color:#268bd2">N</span>
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;paste_private&#34;
</span><span style="color:#586e75"></span>
0
-----------------------------7<span style="color:#268bd2">e16a21104fe</span>
Content-Disposition: <span style="color:#268bd2">form-data</span><span style="color:#586e75">; name=&#34;paste_name&#34;
</span><span style="color:#586e75"></span>

-----------------------------7<span style="color:#268bd2">e16a21104fe--</span>
...</code></pre></div>
<p>This is nice but we do not see where the data is sent or any GET requests.</p>

<h1 id="13-not-echo-mirage-hooking-ie-part-2">13 - Not Echo Mirage - Hooking IE - Part 2</h1>

<p>To gather more information we need to hook more functions.</p>

<h2 id="httpopenrequest">HttpOpenRequest</h2>

<p>The first parameter for <code>HttpSendRequest</code> is a handle to a request. This request is returned by a call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa384233(v=vs.85).aspx" title="HttpOpenRequest - MSDN" rel="nofollow" target="_blank">HttpOpenRequest</a>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">HINTERNET</span> <span style="color:#cb4b16">HttpOpenRequest</span>(
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">HINTERNET</span> <span style="color:#cb4b16">hConnect</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   <span style="color:#cb4b16">lpszVerb</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   <span style="color:#cb4b16">lpszObjectName</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   <span style="color:#cb4b16">lpszVersion</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   <span style="color:#cb4b16">lpszReferer</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">LPCTSTR</span>   *<span style="color:#cb4b16">lplpszAcceptTypes</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">DWORD</span>     <span style="color:#cb4b16">dwFlags</span>,
  <span style="color:#268bd2">_In_</span> <span style="color:#cb4b16">DWORD_PTR</span> <span style="color:#cb4b16">dwContext</span>
);</code></pre></div>
<p>Interesting parameters are:</p>

<ul>
<li><code>lpszVerb</code>: *str to HTTP verb. If NULL, verb is <code>GET</code>.</li>
<li><code>lpszObjectName</code>: *str to name of target obj. &quot;This is generally a file name, an executable module, or a search specifier.&quot;</li>
<li><code>lpszReferer</code>: *str to referer (we already seen it in <code>HttpSendRequest.lpszHeaders</code>).</li>
</ul>





<figure class="code">
  <figcaption>
  	<span>12-NotEchoMirage-IE-2.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">from</span> winappdbg.win32 <span style="color:#719e07">import</span> PVOID, DWORD, HANDLE


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>

    apiHooks <span style="color:#719e07">=</span> {

        <span style="color:#586e75"># Hooks for the wininet.dll library - note this is case-sensitive</span>
        <span style="color:#2aa198">&#34;wininet.dll&#34;</span>: [

            <span style="color:#586e75"># Function            Signature</span>
            (<span style="color:#2aa198">&#34;HttpSendRequestW&#34;</span>, (HANDLE, PVOID, DWORD, PVOID, DWORD)),
            (<span style="color:#2aa198">&#34;HttpOpenRequestW&#34;</span>, (HANDLE, PVOID, PVOID, PVOID, PVOID, PVOID,
                                  DWORD, PVOID)),
        ],
    }

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_HttpSendRequestW</span>(<span style="color:#268bd2">self</span>, event, ra, hRequest, lpszHeaders,
                             dwHeadersLength, lpOptional, dwOptionalLength):

        <span style="color:#719e07">...</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_HttpOpenRequestW</span>(<span style="color:#268bd2">self</span>, event, ra, hConnect, lpszVerb,
                             lpszObjectName, lpszVersion, lpszReferer,
                             lplpszAcceptTypes, dwFlags, dwContext):

        process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()

        verb <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpszVerb, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)
        <span style="color:#719e07">if</span> verb <span style="color:#719e07">is</span> <span style="color:#268bd2">None</span>:
            verb <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;GET&#34;</span>

        obj <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>peek_string(lpszObjectName, fUnicode<span style="color:#719e07">=</span><span style="color:#268bd2">True</span>)

        mylogger<span style="color:#719e07">.</span>log_text(winapputil<span style="color:#719e07">.</span>utils<span style="color:#719e07">.</span>get_line())
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;HttpOpenRequestW&#34;</span>)
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;verb: </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> verb)
        mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;obj : </span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> obj)
        mylogger<span style="color:#719e07">.</span>log_text(winapputil<span style="color:#719e07">.</span>utils<span style="color:#719e07">.</span>get_line())</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<h2 id="hooking-more-ie">Hooking more IE</h2>

<p>Let's see what we can get this time (and if we need to dig further). Note I have removed a lot of junk from the output.</p>

<p>Here's what we <code>GET</code> for <code>example.com</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#268bd2">$</span> <span style="color:#cb4b16">python</span> <span style="color:#2aa198">13</span>-<span style="color:#cb4b16">NotEchoMirage-IE-2.py</span> -<span style="color:#cb4b16">r</span> &#34;<span style="color:#cb4b16">C</span>:\<span style="color:#cb4b16">Program</span> <span style="color:#cb4b16">Files</span>\<span style="color:#cb4b16">Internet</span> <span style="color:#cb4b16">Explorer</span>\<span style="color:#cb4b16">iexplore.exe</span>&#34;
...
[08:49:34<span style="color:#268bd2">.0502</span>] ---------------------------------------------------------------------------
[08:49:36<span style="color:#268bd2">.0494</span>] ---------------------------------------------------------------------------
[08:49:36<span style="color:#268bd2">.0494</span>] <span style="color:#cb4b16">HttpOpenRequestW</span>
[08:49:36<span style="color:#268bd2">.0494</span>] <span style="color:#cb4b16">verb</span>: <span style="color:#cb4b16">GET</span>
[08:49:36<span style="color:#268bd2">.0494</span>] <span style="color:#cb4b16">obj</span> : /
[08:49:36<span style="color:#268bd2">.0494</span>] ---------------------------------------------------------------------------
[08:49:36<span style="color:#268bd2">.0505</span>] ---------------------------------------------------------------------------
[08:49:36<span style="color:#268bd2">.0505</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[08:49:36<span style="color:#268bd2">.0505</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Accept-Language</span>: <span style="color:#cb4b16">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
...</code></pre></div>
<p>Similar for <code>google.com</code> (today is veterans' day hence the requests to get the logo):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">...
[08:50:57<span style="color:#268bd2">.0878</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0217</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0217</span>] <span style="color:#cb4b16">HttpOpenRequestW</span>
[08:50:58<span style="color:#268bd2">.0217</span>] <span style="color:#cb4b16">verb</span>: <span style="color:#cb4b16">GET</span>
[08:50:58<span style="color:#268bd2">.0217</span>] <span style="color:#cb4b16">obj</span> : /
[08:50:58<span style="color:#268bd2">.0217</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0217</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0217</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[08:50:58<span style="color:#268bd2">.0217</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Accept-Language</span>: <span style="color:#cb4b16">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
[08:50:58<span style="color:#268bd2">.0479</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0479</span>] <span style="color:#cb4b16">HttpOpenRequestW</span>
[08:50:58<span style="color:#268bd2">.0479</span>] <span style="color:#cb4b16">verb</span>: <span style="color:#cb4b16">GET</span>
[08:50:58<span style="color:#268bd2">.0479</span>] <span style="color:#cb4b16">obj</span> : /<span style="color:#cb4b16">logos</span>/<span style="color:#cb4b16">doodles</span>/<span style="color:#2aa198">2017</span>/<span style="color:#cb4b16">veterans-day-2017-5171750613549056-s.png</span>
[08:50:58<span style="color:#268bd2">.0479</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0489</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Referer</span>: <span style="color:#cb4b16">https</span>://<span style="color:#cb4b16">www.google.com</span>/
Accept-Language: <span style="color:#268bd2">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
[08:50:58<span style="color:#268bd2">.0489</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">HttpOpenRequestW</span>
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">verb</span>: <span style="color:#cb4b16">GET</span>
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">obj</span> : /<span style="color:#cb4b16">logos</span>/<span style="color:#cb4b16">doodles</span>/<span style="color:#2aa198">2017</span>/<span style="color:#cb4b16">veterans-day-2017-5171750613549056-l.png</span>
[08:50:58<span style="color:#268bd2">.0489</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0489</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[08:50:58<span style="color:#268bd2">.0489</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Referer</span>: <span style="color:#cb4b16">https</span>://<span style="color:#cb4b16">www.google.com</span>/
Accept-Language: <span style="color:#268bd2">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
[08:50:58<span style="color:#268bd2">.0499</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0499</span>] <span style="color:#cb4b16">HttpOpenRequestW</span>
[08:50:58<span style="color:#268bd2">.0499</span>] <span style="color:#cb4b16">verb</span>: <span style="color:#cb4b16">GET</span>
[08:50:58<span style="color:#268bd2">.0499</span>] <span style="color:#cb4b16">obj</span> : /<span style="color:#cb4b16">images</span>/<span style="color:#cb4b16">icons</span>/<span style="color:#cb4b16">hpcg</span>/<span style="color:#cb4b16">usflag-transbg_42.png</span>
[08:50:58<span style="color:#268bd2">.0499</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0499</span>] ---------------------------------------------------------------------------
[08:50:58<span style="color:#268bd2">.0499</span>] <span style="color:#cb4b16">HttpSendRequestW</span>
[08:50:58<span style="color:#268bd2">.0499</span>] <span style="color:#cb4b16">Headers</span> <span style="color:#cb4b16">Referer</span>: <span style="color:#cb4b16">https</span>://<span style="color:#cb4b16">www.google.com</span>/
Accept-Language: <span style="color:#268bd2">en-US</span>
User-Agent: <span style="color:#268bd2">Mozilla</span>/<span style="color:#2aa198">5</span><span style="color:#cb4b16">.0</span> (<span style="color:#cb4b16">Windows</span> <span style="color:#cb4b16">NT</span> <span style="color:#2aa198">6</span><span style="color:#cb4b16">.1</span><span style="color:#586e75">; Trident/7.0; rv:11.0) like Gecko
</span><span style="color:#586e75"></span><span style="color:#cb4b16">Accept-Encoding</span>: <span style="color:#cb4b16">gzip</span>, <span style="color:#cb4b16">deflate</span>
...</code></pre></div>
<p>We are not getting everything. That means we need to hook more functions.</p>

<p>At this point I am moving on to a different program because the three people that will read this blog are already bored. <em>ahem</em> I will leave the rest of IE stuff <em>as an exercise for the readers</em>. Academia, amirite fellow intellectuals?</p>

<blockquote>
<p>Here in my university ivory tower, just published this new paper here. It's fun to look myself up on Google Scholar. But you know what I like more than being cited? KNOWLEDGE.</p>
</blockquote>

<h1 id="14-not-echo-mirage-firefox">14 - Not Echo Mirage - Firefox</h1>

<p>The other item in that malware hooking table (well part of the table that I copied) is Firefox.</p>

<h2 id="pr-write-in-rust">PR_Write (in Rust)</h2>

<p>Hooking pre-TLS Firefox encryption is trickier because it does not use Windows APIs. In Firefox it's <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSPR/Reference/PR_Write" title="PR_Write - Mozilla Developer Network" rel="nofollow" target="_blank">PR_Write</a>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">PRInt32 <span style="color:#268bd2">PR_Write</span>(
    PRFileDesc <span style="color:#719e07">*</span>fd,
    <span style="color:#719e07">const</span> <span style="color:#dc322f">void</span> <span style="color:#719e07">*</span>buf,
    PRInt32 amount);

fd:     A pointer to the PRFileDesc object <span style="color:#719e07">for</span> a file or socket
buf:    A pointer to the buffer holding the data to be written
amount: The amount of data, in bytes, to be written from the buffer</code></pre></div>
<p>Could not talk about Firefox, <code>PR_Write</code> and not make a &quot;Re-write in Rust&quot;<sup class="footnote-ref" id="fnref:rewrite-rust"><a href="#fn:rewrite-rust">8</a></sup> joke. Maybe we should hook Chrome and talk about generics.</p>

<h2 id="where-is-pr-write">Where is PR_Write?</h2>

<p>Tl;dr it's exported in <code>nss3.dll</code>.</p>

<p>The Mozilla docs are less helpful than MSDN. MSDN lists the DLL that exports the function but Mozilla does not. Searching in MDN (Mozilla Developer Network) got me nowhere.</p>

<p>That malware table listed it under <code>nspr4.dll</code> and search engine results also mostly say the same thing. Grey Hat Python also lists it in the same DLL. In my Firefox (32-bit 56.0.2) there's no such DLL in <code>C:\Program Files\Mozilla Firefox</code><sup class="footnote-ref" id="fnref:32-bit-program-files"><a href="#fn:32-bit-program-files">9</a></sup>.</p>

<p>We finally get to <a href="https://wiremask.eu/articles/hooking-firefox-with-frida/" title="Hooking Firefox with Frida - Wiremask.eu" rel="nofollow" target="_blank">Hooking Firefox with Frida</a> from Wiremask.eu which is doing exactly what we do but with Frida<sup class="footnote-ref" id="fnref:frida-vs-winappdbg"><a href="#fn:frida-vs-winappdbg">10</a></sup>. Ew, JavaScript code embedded in Python (j/k). Our answer is there <code>nss3.dll</code>.</p>

<h2 id="null-terminated-strings-vs-random-buffer">Null-Terminated Strings vs. Random Buffer</h2>

<p>Pointers in <code>PR_Write</code> point to different kind of data than what we saw in IE. In IE we were mostly dealing with pointers to null-terminated strings. Meaning we could call <code>peek_string</code> and it would go and read until the null-terminator (which is <code>00 00</code> for UTF-16<sup class="footnote-ref" id="fnref:utf-16-terminator"><a href="#fn:utf-16-terminator">11</a></sup>). Now we have a random buffer but we have the length so we have to go and read that many bytes from memory directly. It's good to see both types of string/data storage in action<sup class="footnote-ref" id="fnref:c-vs-pascal-strings"><a href="#fn:c-vs-pascal-strings">12</a></sup>.</p>





<figure class="code">
  <figcaption>
  	<span>14-NotEchoMirage-FF.py</span>
  </figcaption>
  <div class="codewrapper">
    <div class="highlight"><div style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#495050">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">from</span> winappdbg.win32 <span style="color:#719e07">import</span> PVOID, DWORD, HANDLE


<span style="color:#719e07">class</span> <span style="color:#268bd2">DebugEvents</span>(winappdbg<span style="color:#719e07">.</span>EventHandler):
    <span style="color:#2aa198">&#34;&#34;&#34;
</span><span style="color:#2aa198">    Event handler class.
</span><span style="color:#2aa198">    event: https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/event.py
</span><span style="color:#2aa198">    &#34;&#34;&#34;</span>
    apiHooks <span style="color:#719e07">=</span> {

        <span style="color:#586e75"># Hooks for the nss3.dll library</span>
        <span style="color:#2aa198">&#39;nss3.dll&#39;</span>: [

            (<span style="color:#2aa198">&#39;PR_Write&#39;</span>, (PVOID, PVOID, PVOID)),
        ],
    }

    <span style="color:#719e07">def</span> <span style="color:#268bd2">pre_PR_Write</span>(<span style="color:#268bd2">self</span>, event, ra, fd, buf, amount):

        process <span style="color:#719e07">=</span> event<span style="color:#719e07">.</span>get_process()

        <span style="color:#719e07">if</span> (amount <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">100</span>) <span style="color:#719e07">and</span> (amount <span style="color:#719e07">&lt;</span> <span style="color:#2aa198">1000</span>):
            mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;PR_Write&#34;</span>)

            <span style="color:#586e75"># https://github.com/MarioVilas/winappdbg/blob/master/winappdbg/process.py#L1581</span>
            contents <span style="color:#719e07">=</span> process<span style="color:#719e07">.</span>read(buf, amount)

            mylogger<span style="color:#719e07">.</span>log_text(<span style="color:#2aa198">&#34;</span><span style="color:#2aa198">%s</span><span style="color:#2aa198">&#34;</span> <span style="color:#719e07">%</span> <span style="color:#b58900">str</span>(contents))

            mylogger<span style="color:#719e07">.</span>log_text(winapputil<span style="color:#719e07">.</span>utils<span style="color:#719e07">.</span>get_line())</code></pre></td></tr></table>
</div>
</div>
  </div>
</figure>

<p>Things are similar but as we saw above, the buffer might contain null-bytes (e.g. binary data vs. null-terminated strings). So we use <code>process.read</code> to read <code>amount</code> bytes from the place <code>buf</code> points to. Then we convert it to string and print it.</p>

<h2 id="firefox-in-action">Firefox in Action</h2>

<p>Before you run this, beware that <code>PR_Write</code> is used in a lot more than just TLS in Firefox. This will be slow and Firefox might be unresponsive for a minute after you go to a website. The logs will also gather a lot of garbage. As a result I am only printing buffers that are between 100 and 1000 bytes.</p>

<p>I suggest piping the output to a file instead of command prompt with the <code>-o</code> switch like this:</p>

<ul>
<li><code>$ python 14-NotEchoMirage-FF.py -r &quot;C:\Program Files\Mozilla Firefox\firefox.exe&quot; -o firefox-1.txt</code></li>
</ul>

<p>After starting Firefox and entering <code>example.com</code>, Firefox will die for a minute or so. But loot is inside the log file. If you do webapps, you have seen the annoying captive portal detection requests <code>detectportal.firefox.com</code> in Burp. I hate those and Brian King agrees and has <a href="https://www.blackhillsinfosec.com/towards-quieter-firefox/" title="Towards a Quieter Firefox - Black Hills Information Security" rel="nofollow" target="_blank">some tips</a> on how to make them go away.</p>
<pre><code>[09:23:41.0933] Starting C:\Program Files\Mozilla Firefox\firefox.exe
[09:23:42.0835] PR_Write
[09:23:42.0835] GET /success.txt HTTP/1.1

Host: detectportal.firefox.com
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cache-Control: no-cache
Pragma: no-cache
Connection: keep-alive</code></pre>
<p>Oh shit, OCSP<sup class="footnote-ref" id="fnref:OSCP"><a href="#fn:OSCP">13</a></sup>. Alert the authorities, certificates are expiring.</p>
<pre><code>[09:23:43.0467] PR_Write
[09:23:43.0467] POST /ocsp HTTP/1.1

Host: clients1.google.com
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Length: 75
Content-Type: application/ocsp-request
Connection: keep-alive

[payload removed]</code></pre>
<p>Mooooom, Firefox is tracking me.</p>
<pre><code>[09:23:44.0049] PR_Write
[09:23:44.0049] GET /v1/country?key=fff72d56-b040-4205-9a11-82feda9d83a3 HTTP/1.1

Host: location.services.mozilla.com
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Origin: null
Connection: keep-alive</code></pre>
<p>And finally our request to <code>example.com</code></p>
<pre><code>[09:24:25.0388] PR_Write
[09:24:25.0388] GET / HTTP/1.1

Host: example.com
User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
If-Modified-Since: Fri, 09 Aug 2013 23:54:35 GMT
If-None-Match: &#34;359670651&#34;</code></pre>
<h1 id="conclusion">Conclusion</h1>

<p>I wanted to continue but this blog is already long enough. The markdown file is at 45KBs and counting (mainly because I pasted a lot of code, crap and went full-academia with links and footnotes). But I am bored and you are most likely too.</p>

<p>Go out there and hook stuff. Practice on eavesdropping and tune in for part 3 where we learn how to manipulate function arguments and return values.</p>

<p>If you have feedback, you know where to find me. And check out the rest of the <a href="https://github.com/parsiya/Parsia-Clone/" title="Parsia Clone on Github" rel="nofollow" target="_blank">clone</a>, there's some good stuff there.</p>

<!-- Footnotes -->

<!-- Links -->
<div class="footnotes">

<hr />

<ol>
<li id="fn:raymond-1">Raymond's blog, <a href="https://blogs.msdn.microsoft.com/oldnewthing/" title="The Old New Thing - Raymond Chen's MSDN blog" rel="nofollow" target="_blank">The Old New Thing</a> has interesting articles.
 <a class="footnote-return" href="#fnref:raymond-1"><sup>[return]</sup></a></li>
<li id="fn:dll-land-addr">On a 32-bit machine we will most likely get an address starting with <code>0x7F</code> which is in DLL-land.
 <a class="footnote-return" href="#fnref:dll-land-addr"><sup>[return]</sup></a></li>
<li id="fn:ansi-wide-msdn">See <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd374089(v=vs.85).aspx" title="Unicode in the Windows API - MSDN" rel="nofollow" target="_blank">MSDN</a> for their differences.
 <a class="footnote-return" href="#fnref:ansi-wide-msdn"><sup>[return]</sup></a></li>
<li id="fn:asm-highlight">Looks much better with <code>asm</code> highlighting.
 <a class="footnote-return" href="#fnref:asm-highlight"><sup>[return]</sup></a></li>
<li id="fn:hook-breakpoint">We are essentially putting a breakpoint for each function at the addresses we just resolved.
 <a class="footnote-return" href="#fnref:hook-breakpoint"><sup>[return]</sup></a></li>
<li id="fn:64-bit">In <a href="https://msdn.microsoft.com/en-us/library/ms235286.aspx" title="Overview of x64 Calling Conventions - MSDN" rel="nofollow" target="_blank">64-bit</a> processes, first four arguments are stored in <code>rcx</code>, <code>rdx</code>, <code>r8</code>, <code>r9</code> and the rest are pushed to the stack (in reverse order) like 32-bit functions.
 <a class="footnote-return" href="#fnref:64-bit"><sup>[return]</sup></a></li>
<li id="fn:no-anchor">The heading does not have an anchor so I had to link to the first table row. Generate IDs for all your headings people.
 <a class="footnote-return" href="#fnref:no-anchor"><sup>[return]</sup></a></li>
<li id="fn:rewrite-rust"><strong>F E A R L E S S - C O N C U R R E N C Y</strong>
 <a class="footnote-return" href="#fnref:rewrite-rust"><sup>[return]</sup></a></li>
<li id="fn:32-bit-program-files">Remember we are in a 32-bit VM so we have only one <code>Program Files</code> not two like x64 Windows that also have <code>Program Files (x86)</code> for 32-bit emulation.
 <a class="footnote-return" href="#fnref:32-bit-program-files"><sup>[return]</sup></a></li>
<li id="fn:frida-vs-winappdbg">Yet another TODO. Try Frida vs. WinAppDbg in terms of performance.
 <a class="footnote-return" href="#fnref:frida-vs-winappdbg"><sup>[return]</sup></a></li>
<li id="fn:utf-16-terminator">That is another <em>fun</em> exercise. Read UTF-16 null-terminated strings from memory and see how they are stored.
 <a class="footnote-return" href="#fnref:utf-16-terminator"><sup>[return]</sup></a></li>
<li id="fn:c-vs-pascal-strings">For more information, search for C-style vs. Pascal-style strings.
 <a class="footnote-return" href="#fnref:c-vs-pascal-strings"><sup>[return]</sup></a></li>
<li id="fn:OSCP">Not to be confused with the current infosec meme-cert.
 <a class="footnote-return" href="#fnref:OSCP"><sup>[return]</sup></a></li>
</ol>
</div>
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Nov 11, 2017</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="http://localhost:1313/tags/python">python</a>  <a class="category" href="http://localhost:1313/tags/function-hooking">function hooking</a>  
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://localhost:1313/blog/2017-11-09-winappdbg-part-1-basics/" title="WinAppDbg - Part 1 - Basics">WinAppDbg - Part 1 - Basics</a>
    

    
      <a class="basic-alignment right" href="http://localhost:1313/blog/2017-11-15-winappdbg-part-3-manipulating-function-calls/" title="WinAppDbg - Part 3 - Manipulating Function Calls">WinAppDbg - Part 3 - Manipulating Function Calls</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "parsiya" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Who am I?</h1>
    

    <p>
      
        <p>I am Pitchaimuthu Muthaiya, a senior security engineer.</p>

<p>I write about application tamil words and roots of words.</p>

<p>Click on <a href="/about/">About Me!</a> to know more.</p>

      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" rel="noopener noreferrer" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
      
        <a target="_blank" rel="noopener noreferrer" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-keybase fa-3x"></i></a> 
      
      <a target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/parsiya" title="https://www.linkedin.com/in/parsiya"><i class="fa fa-linkedin fa-3x"></i></a>
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Collections</h1>
        
        
          <li>
            <a href="http://localhost:1313/categories/thick-client-proxying/" title="Thick Client Proxying" >Thick Client Proxying</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/writeup/" title="CTFs/Writeups" >CTFs/Writeups</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/attack-surface-analysis/" title="Attack Surface Analysis" >Attack Surface Analysis</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/bug-bounty/" title="Bug Bounty" >Bug Bounty</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/go/" title="Go/Golang" >Go/Golang</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/blockchain/" title="Blockchain" >Blockchain</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/burp-extension/" title="Burp Extension Development" >Burp Extension Development</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/automation/" title="Automation" >Automation</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/reverse-engineering/" title="Reverse Engineering" >Reverse Engineering</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/crypto/" title="Crypto(graphy)" >Crypto(graphy)</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/winappdbg/" title="WinAppDbg" >WinAppDbg</a>
          </li>
        
          <li>
            <a href="https://awsome.pw" title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability" >AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a>
          </li>
        
      </section>
    
  

  
  
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2021 Parsia - <a href="http://localhost:1313/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    



    
    
    

    
  </body>
</html>

