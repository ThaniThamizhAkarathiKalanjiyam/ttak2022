<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>Thick Client Proxying - Part 8 - Notes on Proxying Windows Services</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="http://localhost:1313/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="[Parsia Hakimian Parsiya infosec information security]">
  <meta name="author" content="Parsia">

  
  <meta name="generator" content="Hugo 0.83.1" />

  
  

  
  
    

  
    <meta name="twitter:card" content="summary"/>
  
  
  <meta name="twitter:title" content="Thick Client Proxying - Part 8 - Notes on Proxying Windows Services"/>
  <meta name="twitter:description" content="These are my notes about proxying Windows services. Being run from a different account (usually LocalSystem).

Proxy settings are usually configured per user and are not applicable to Windows services.

If you have to proxy a Windows service, here are some of the things you can try (and hope they work).

There are also some issues when using netsh to set WinHTTP proxies for 32-bit applications on Windows 7 64-bit."/>
  
  <meta name="twitter:domain" content="parsiya.net"/>
  <meta name="twitter:creator" content="@CryptoGangsta"/>

  

  
  



</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="http://localhost:1313/">அஃக</a></h1>
    <h2>தமிழின் பெரிய சொற்தொகுப்பு</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="http://localhost:1313/about/">» About Me!</option>
      
        <option value="http://localhost:1313/letters/">» எழுத்து</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="http://localhost:1313/about/" title="About Me!"  target="_blank"  rel="noopener noreferrer">About Me!</a></li>
    
  
    
      <li><a href="http://localhost:1313/letters/" title="எழுத்து"  target="_blank"  rel="noopener noreferrer">எழுத்து</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="http://localhost:1313/index.xml" target="_blank" type="application/rss+xml" title="RSS" rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank" rel="noopener noreferrer">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:http://localhost:1313/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Oct 8, 2017
     - 4 minute read 
     - <a href="http://localhost:1313/blog/2017-10-08-thick-client-proxying-part-8-notes-on-proxying-windows-services/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="http://localhost:1313/categories/thick-client-proxying/">Thick Client Proxying </a><a class="label" href="http://localhost:1313/categories/windows-service/">Windows Service </a>
    
  </p>
  <h1 class="entry-title">
     Thick Client Proxying - Part 8 - Notes on Proxying Windows Services 
  </h1>
</header>


        <div class="entry-content">
          
          
          
          <p>These are my notes about proxying Windows services. Being run from a different account (usually LocalSystem).</p>

<p>Proxy settings are usually configured per user and are not applicable to Windows services.</p>

<p>If you have to proxy a Windows service, here are some of the things you can try (and hope they work).</p>

<p>There are also some issues when using <code>netsh</code> to set WinHTTP proxies for 32-bit applications on Windows 7 64-bit.</p>

<!-- MarkdownTOC -->

<ul>
<li><a href="#some-background-knowledge">Some Background Knowledge</a></li>
<li><a href="#traditional-techniques-or-try-these-anyways">Traditional Techniques or &quot;Try These Anyways&quot;</a>

<ul>
<li><a href="#wininet-or-internet-explorer-proxy-settings">WinINET or Internet Explorer Proxy Settings</a></li>
<li><a href="#winhttp-proxy-settings">WinHTTP Proxy Settings</a></li>
<li><a href="#netsh-winhttp-for-32-bit-processes-on-windows-7-64-bit">netsh winhttp for 32-bit Processes on Windows 7 64-bit</a></li>
<li><a href="#run-the-service-executable-manually">Run the Service Executable Manually</a></li>
<li><a href="#disable-per-user-wininet-proxy-settings">Disable Per-User WinINET Proxy Settings</a></li>
<li><a href="#net-config-file">.NET Config File</a></li>
<li><a href="#net-framework-machine-configuration-file">.NET Framework Machine Configuration File</a></li>
</ul></li>
</ul>

<!-- /MarkdownTOC -->

<p><a name="some-background-knowledge"></a></p>

<h1 id="some-background-knowledge">Some Background Knowledge</h1>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/ieinternals/2013/10/11/understanding-web-proxy-configuration/" rel="nofollow" target="_blank">Understanding Web Proxy Configuration - MSDN</a>. This is a pretty useful read for Windows proxying. If you have to choose between this blog and that article, choose the MSDN article.</li>
<li><a href="http://localhost:1313/blog/2016-07-28-thick-client-proxying-part-6-how-https-proxies-work/" title="Thick Client Proxying - Part 6: How HTTPs Proxies Work" rel="nofollow" target="_blank">Part 6 - How HTTP(s) Proxies Work</a></li>
</ul>

<p><a name="traditional-techniques-or-try-these-anyways"></a></p>

<h1 id="traditional-techniques-or-try-these-anyways">Traditional Techniques or &quot;Try These Anyways&quot;</h1>

<p>These are things that usually work for most Windows applications.</p>

<p><a name="wininet-or-internet-explorer-proxy-settings"></a></p>

<h2 id="wininet-or-internet-explorer-proxy-settings">WinINET or Internet Explorer Proxy Settings</h2>

<p>Usually called the Internet Explorer proxy settings. These usually work for most <a href="http://localhost:1313/blog/2016-07-28-thick-client-proxying-part-6-how-https-proxies-work/#5-proxy-aware-clients" title="What are Proxy-Aware Clients" rel="nofollow" target="_blank">proxy-aware</a> applications.</p>

<p>Shortcut <code>control inetcpl.cpl,,4</code>.</p>

<p><a name="winhttp-proxy-settings"></a></p>

<h2 id="winhttp-proxy-settings">WinHTTP Proxy Settings</h2>

<p>WinHTTP is generally the proxy for Windows services. You can either set specific proxies or tell it to import IE proxy settings (see above).</p>

<p>Run in admin command prompt:</p>

<ul>
<li>Use IE: <code>netsh winhttp import proxy source=ie</code>. Note: You need to set WinINET settings <strong>before</strong> this command. This command uses a snapshot of IE settings and imports them. If you change IE settings after, it will not get updated and you have to run it again.</li>
<li>Set proxy: <code>netsh winhttp set proxy proxy-server=&quot;http=localhost:8080;https=localhost:8443&quot; bypass-list=&quot;*.whatever.com;localhost&quot;</code>.</li>
<li>Reset proxy: <code>netsh winhttp reset proxy</code>.</li>
</ul>

<p>More info: <a href="https://technet.microsoft.com/en-us/library/cc731131(v=ws.10).aspx#BKMK_5" rel="nofollow" target="_blank">MSDN - Netsh Commands for Windows Hypertext Transfer Protocol (WINHTTP)</a></p>

<p>Location in registry:</p>

<ul>
<li><p>64-bit (note the line-broken &quot;Internet Settings&quot;):</p>

<ul>
<li><p><code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\WinHttpSetting</code></p>

<ul>
<li><p>You will see something like this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">0000  28 00 00 00 00 00 00 00 03 00 00 00 28 00 00 00  |(...........(...|
0010  68 74 74 70 3d 6c 6f 63 61 6c 68 6f 73 74 3a 38  |http=localhost:8|
0020  30 38 30 3b 68 74 74 70 73 3d 6c 6f 63 61 6c 68  |080;https=localh|
0030  6f 73 74 3a 38 34 34 33 18 00 00 00 2a 2e 77 68  |ost:8443....*.wh|
0040  61 74 65 76 65 72 2e 63 6f 6d 3b 6c 6f 63 61 6c  |atever.com;local|
0050  68 6f 73 74                                      |host|</code></pre></div></li>
</ul></li>

<li><p><code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp</code></p></li>
</ul></li>

<li><p>32-bit:</p>

<ul>
<li><code>HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\WinHttpSettings</code></li>
<li><code>HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp</code></li>
</ul></li>
</ul>

<p><a name="netsh-winhttp-for-32-bit-processes-on-windows-7-64-bit"></a></p>

<h3 id="netsh-winhttp-for-32-bit-processes-on-windows-7-64-bit">netsh winhttp for 32-bit Processes on Windows 7 64-bit</h3>

<p>Due to the way 32-bit emulation works, they have their own registry and &quot;system32&quot;:</p>

<ul>
<li>registry hive: <code>hive\Software\Wow6432Node</code>. E.g. <code>HKCU\Software\Wow6432Node\Microsoft\Windows</code></li>
<li>system32: <code>%WINDIR%\SysWOW64</code>. E.g. <code>C:\windows\SysWOW64</code></li>
</ul>

<p>On Windows 7, when you use <code>netsh</code> to write WinHTTP proxy settings, only the 64-bit registry keys are changed. For 32-bit apps you need to explicitly run <code>%WINDIR%\SysWOW64\netsh.exe</code>.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#586e75"># change winhttp proxy setting</span>
C:\&gt;netsh winhttp import proxy source=ie

Current WinHTTP proxy settings:

    Proxy Server(s) :  localhost:8100
    Bypass List     :  (none)

<span style="color:#586e75"># not modified for 32-bit applications</span>
C:\&gt;c:\Windows\SysWOW64\netsh.exe winhttp show proxy

Current WinHTTP proxy settings:

    Direct access (no proxy server).</code></pre></div>
<p>Presumably this has been fixed for later versions of Windows, but double-check to be sure.</p>

<p><a name="run-the-service-executable-manually"></a></p>

<h2 id="run-the-service-executable-manually">Run the Service Executable Manually</h2>

<p>This might help bring it under your &quot;jurisdiction&quot; and thus your proxy settings will apply. By default each user has their own proxy settings.</p>

<p>You can use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer" rel="nofollow" target="_blank">Process Explorer</a> or <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" rel="nofollow" target="_blank">Process Monitor</a> or other tools to discover the parameters to run the service (if any).</p>

<p><a name="disable-per-user-wininet-proxy-settings"></a></p>

<h2 id="disable-per-user-wininet-proxy-settings">Disable Per-User WinINET Proxy Settings</h2>

<p>By default they are per-user, you set the following registry key to <code>0</code>:</p>

<ul>
<li><code>HKLM\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\ProxySettingsPerUser</code></li>
</ul>

<p><strong>But after this change you will need admin access to modify proxy settings.</strong></p>

<p><a name="net-config-file"></a></p>

<h2 id="net-config-file">.NET Config File</h2>

<p>See detailed info in <a href="http://localhost:1313/blog/2017-10-07-thick-client-proxying-part-7-proxying-.net-applications-via-config-file/" title="Thick Client Proxying" rel="nofollow" target="_blank">part 7</a></p>

<p>.NET applications can read settings from config files. This is an XML file named <code>applicationName.exe.config</code>.</p>

<p>Add these settings (<code>configuration</code> is already present in existing config files):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;configuration&gt;</span> 
  <span style="color:#268bd2">&lt;system.net&gt;</span>  
    <span style="color:#268bd2">&lt;defaultProxy&gt;</span>  
      <span style="color:#268bd2">&lt;proxy</span>  
        usesystemdefault=<span style="color:#2aa198">&#34;true&#34;</span>   // use IE proxy settings
        proxyaddress=<span style="color:#2aa198">&#34;http://192.168.1.10:3128&#34;</span>  // remember to keep &#34;http://&#34; here
        bypassonlocal=<span style="color:#2aa198">&#34;true&#34;</span>  
      <span style="color:#268bd2">/&gt;</span>  
      <span style="color:#268bd2">&lt;bypasslist&gt;</span>  
        <span style="color:#268bd2">&lt;add</span> address=<span style="color:#2aa198">&#34;[a-z]+\.contoso\.com&#34;</span> <span style="color:#268bd2">/&gt;</span>  
      <span style="color:#268bd2">&lt;/bypasslist&gt;</span>  
    <span style="color:#268bd2">&lt;/defaultProxy&gt;</span>  
  <span style="color:#268bd2">&lt;/system.net&gt;</span>  
<span style="color:#268bd2">&lt;/configuration&gt;</span>  </code></pre></div>
<p>Note <code>usesystemdefault</code> and <code>proxyaddress</code> are mutually exclusive.</p>

<ul>
<li>Keep <code>http://</code> in <code>proxy address</code> even if you are using an HTTPS proxy like Burp, it will proxy TLS.</li>
<li>Often <code>usesystemdefault</code> does not work because your user and the user running the service are different and have their own proxy settings. Running the service binary manually may help.</li>
</ul>

<p>Use tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" rel="nofollow" target="_blank">process monitor</a> to detect if the application is looking for this or any other config file.</p>

<p><a name="net-framework-machine-configuration-file"></a></p>

<h2 id="net-framework-machine-configuration-file">.NET Framework Machine Configuration File</h2>

<p>You can use a similar config file for the entire machine. Meaning any application running via that .NET framework will use those settings.</p>

<p>Location is <code>%WINDIR%\Microsoft.NET\Framework|Framework64\[version]\Config\machine.config</code>.</p>

<p>Note that you need to change the config for both 32 and 64-bit frameworks (Framework|Framework64) and each version (e.g. 2, 3 or 4) separately.</p>

<p>For example for 64-bit .NET Framework 4.x (anything 4.x is under 4):
- <code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config</code></p>

<p>To learn more about the config file (which is really recommended) see file <code>machine.config.comments</code> in the same location. It has comments and examples.</p>

<!-- links -->
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Parsia</span></span>
    
    <time>Oct 8, 2017</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="http://localhost:1313/tags/wininet">wininet</a>  <a class="category" href="http://localhost:1313/tags/winhttp">winhttp</a>  <a class="category" href="http://localhost:1313/tags/netsh">netsh</a>  
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://localhost:1313/blog/2017-10-07-thick-client-proxying-part-7-proxying-.net-applications-via-config-file/" title="Thick Client Proxying - Part 7 - Proxying .NET Applications via Config File">Thick Client Proxying - Part 7 - Proxying .NET Applications via Config File</a>
    

    
      <a class="basic-alignment right" href="http://localhost:1313/blog/2017-10-23-run-line-vs.-cmd-vs.-powershell/" title="Run Line vs. cmd vs. PowerShell">Run Line vs. cmd vs. PowerShell</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "parsiya" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Who am I?</h1>
    

    <p>
      
        <p>I am Pitchaimuthu Muthaiya, a senior security engineer.</p>

<p>I write about application tamil words and roots of words.</p>

<p>Click on <a href="/about/">About Me!</a> to know more.</p>

      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" rel="noopener noreferrer" href="https://github.com/parsiya/" title="https://github.com/parsiya/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/cryptogangsta/" title="https://twitter.com/cryptogangsta/"><i class="fa fa-twitter fa-3x"></i></a>
      
        <a target="_blank" rel="noopener noreferrer" href="https://keybase.io/parsiya/" title="https://keybase.io/parsiya/"><i class="fa fa-keybase fa-3x"></i></a> 
      
      <a target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/parsiya" title="https://www.linkedin.com/in/parsiya"><i class="fa fa-linkedin fa-3x"></i></a>
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Collections</h1>
        
        
          <li>
            <a href="http://localhost:1313/categories/thick-client-proxying/" title="Thick Client Proxying" >Thick Client Proxying</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/writeup/" title="CTFs/Writeups" >CTFs/Writeups</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/attack-surface-analysis/" title="Attack Surface Analysis" >Attack Surface Analysis</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/bug-bounty/" title="Bug Bounty" >Bug Bounty</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/go/" title="Go/Golang" >Go/Golang</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/blockchain/" title="Blockchain" >Blockchain</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/burp-extension/" title="Burp Extension Development" >Burp Extension Development</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/automation/" title="Automation" >Automation</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/reverse-engineering/" title="Reverse Engineering" >Reverse Engineering</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/crypto/" title="Crypto(graphy)" >Crypto(graphy)</a>
          </li>
        
          <li>
            <a href="http://localhost:1313/categories/winappdbg/" title="WinAppDbg" >WinAppDbg</a>
          </li>
        
          <li>
            <a href="https://awsome.pw" title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability" >AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a>
          </li>
        
      </section>
    
  

  
  
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2021 Parsia - <a href="http://localhost:1313/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io" rel="noopener noreferrer">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/" rel="noopener noreferrer">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    



    
    
    

    
  </body>
</html>

